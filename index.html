<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Manager | クラス統合管理</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@4.2.4/build/index.umd.min.js"></script>
    <link rel="stylesheet" href="style.css?v=3">
    <link rel="stylesheet" href="print_styles.css" media="print">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <header>
        <div class="logo">
            <button id="menuToggle" class="btn-icon"
                style="background: none; border: none; padding: 0.5rem; margin-right: 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2" width="24" height="24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            Grade Manager <span
                style="font-size: 0.6em; background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 4px; font-weight: bold; letter-spacing: 0.05em;">GENE</span>
            <button id="headerHelpBtn"
                style="background:none; border:none; color:#94a3b8; cursor:pointer; padding:4px; display:inline-flex; align-items:center; border-radius:50%; transition:all 0.2s;"
                title="使用方法・セキュリティポリシーを表示">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2" width="20" height="20">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                </svg>
            </button>
        </div>

        <div class="controls">
            <div class="control-group" title="出欠集計の対象年度">
                <select id="headerFiscalYearSelect" style="width: 80px;" title="出欠集計の対象年度">
                    <!-- Populated by JS -->
                </select>
            </div>

            <div class="control-group"
                style="border-left: 1px solid #cbd5e1; padding-left: 0.8rem; margin-left: 0.4rem;">
                <label for="yearSelect">学年</label>
                <select id="yearSelect" title="表示する学年を選択してください">
                    <option value="1">1年</option>
                    <option value="2">2年</option>
                    <option value="3">3年</option>
                    <option value="4">4年</option>
                    <option value="5">5年</option>
                </select>
            </div>

            <div class="control-group" title="表示する対象コースを選択してください">
                <label for="subjectCourseFilterHeader">コース</label>
                <select id="subjectCourseFilterHeader">
                    <option value="">未選択</option>
                    <option value="エネルギー機械">エネルギー機械 (M)</option>
                    <option value="プロダクトデザイン">プロダクトデザイン (D)</option>
                    <option value="エレクトロニクス">エレクトロニクス (E)</option>
                    <option value="知能情報">知能情報 (I)</option>
                </select>
            </div>

            <div class="control-group" id="classSelectGroup" style="display: none;" title="1年生の組を選択してください">
                <label for="classSelect">組</label>
                <select id="classSelect">
                    <option value="1">1組</option>
                    <option value="2">2組</option>
                    <option value="3">3組</option>
                    <option value="4">4組</option>
                </select>
            </div>


            <div class="control-group">
                <label for="studentSelect">学生</label>
                <select id="studentSelect" style="width: 150px;" title="成績を表示する学生を選択してください">
                    <!-- Populated by JS -->
                </select>
            </div>


            <button id="printBtn" class="btn btn-secondary" title="統計・グラフをPDFとして出力します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                PDF
            </button>
            <input type="file" id="jsonFileInput" accept=".json,application/json" class="hidden">
            <input type="file" id="csvFileInput" accept=".csv,text/csv,text/plain,.json,application/json"
                class="hidden">
            <input type="file" id="rosterFileInput" accept=".csv,text/csv,text/plain" class="hidden">
            <!-- Roster Import Button removed from Header, moved to new tab -->
            <!-- Clear button removed from here, moved to Settings -->
            <button id="logoutBtn" class="btn btn-secondary" title="システムをロックしてログアウトします" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Logout
            </button>
        </div>
    </header>

    <!-- Authentication Overlays -->
    <div id="authOverlay" class="modal-overlay" style="z-index: 10000; background: #f1f5f9;">
        <!-- Setup Password (First time) -->
        <div id="setupView" class="modal" style="display: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <div class="modal-header">
                <div class="modal-title">パスワードの初期設定</div>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: #64748b;">成績データを保護するため、ログインパスワードを設定してください。</p>
                <div class="control-group" style="flex-direction: column; align-items: flex-start; gap: 0.8rem;">
                    <label style="font-weight: 600;">新しいパスワード</label>
                    <input type="password" id="setupPass1"
                        style="width: 100%; border-width: 2px; font-size: 1.5rem; padding: 0.8rem; border-color: #e2e8f0; border-radius: 0.5rem;"
                        placeholder="••••••••">
                    <label style="font-weight: 600;">パスワード（確認）</label>
                    <input type="password" id="setupPass2"
                        style="width: 100%; border-width: 2px; font-size: 1.5rem; padding: 0.8rem; border-color: #e2e8f0; border-radius: 0.5rem;"
                        placeholder="••••••••">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" style="width: 100%; height: 3.5rem; font-size: 1.1rem;"
                    id="confirmSetupBtn">設定を保存して開始</button>
            </div>
        </div>

        <!-- Login View -->
        <div id="loginView" class="modal" style="display: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <div class="modal-header">
                <div class="modal-title">Grade Manager ログイン</div>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div
                        style="width: 60px; height: 60px; background: #eef2ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#4f46e5"
                            stroke-width="2" width="32" height="32">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                </div>
                <div class="control-group" style="flex-direction: column; align-items: flex-start; gap: 0.8rem;">
                    <label style="font-weight: 600;">パスワードを入力してください</label>
                    <input type="password" id="loginPass"
                        style="width: 100%; border-width: 2px; font-size: 2rem; padding: 0.8rem; text-align: center; letter-spacing: 0.5rem; border-color: #4f46e5; border-radius: 0.5rem;"
                        placeholder="••••">
                    <div id="loginError" style="color: #ef4444; font-size: 0.85rem; display: none;">パスワードが正しくありません</div>
                </div>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 1rem;">
                <button class="btn btn-primary" style="width: 100%; height: 3.5rem; font-size: 1.1rem;"
                    id="doLoginBtn">ログイン</button>
                <button id="forgotPassBtn"
                    style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 0.85rem; text-decoration: underline;">
                    パスワードを忘れた場合（システムを初期化）
                </button>
            </div>
        </div>
    </div>

    <main id="mainApp" style="display: none;">
        <aside class="sidebar">
            <div class="nav-item active" data-tab="grades" title="各科目の成績を入力・編集します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3 10h18M3 14h18m-9-4v8m-7-6h.01M3 6h18v12a2 2 0 01-2 2H5a2 2 0 01-2-2V6z" />
                </svg>
                学生成績クイック入力
            </div>
            <div class="nav-item" data-tab="grad_requirements" title="卒業要件の達成状況を確認します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                学生卒業要件
            </div>
            <div class="nav-item" data-tab="stats" title="成績の統計情報とグラフを表示します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                学生定期試験のあゆみ
            </div>
            <div class="nav-item" data-tab="stats2" title="学年ごとの評点平均を表示します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                学生評点平均のあゆみ
            </div>
            <div class="nav-item" data-tab="student_summary" title="学生ごとの成績・出欠サマリーを表示します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                学生サマリー
            </div>
            <div class="nav-item" data-tab="attendance" title="出欠カレンダーと統計を表示します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                学生出欠状況
            </div>
            <div class="nav-item" data-tab="class_attendance_stats" title="クラス全体の出欠状況をガントチャート形式で表示します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                クラス出欠状況
            </div>
            <div class="nav-item" data-tab="class_stats" title="クラス全体の成績統計情報を表示します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                </svg>
                クラス状況のまとめ
            </div>
            <div class="nav-item" data-tab="at_risk" title="成績不振な学生を抽出します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                クラス要注意学生
            </div>
            <div class="nav-item" data-tab="seating" title="座席表の作成・ランダム席決めを行います">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                </svg>
                クラス席決め
            </div>
            <div class="nav-item" data-tab="class_officers" title="クラス委員の選出と記録を行います">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                クラス委員
            </div>
            <div class="nav-item" data-tab="timetable" title="クラスの時間割を作成・編集します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 11h6M9 15h3" />
                </svg>
                クラス時間割エディター
            </div>
            <div class="nav-item" data-tab="settings" title="学生名や科目定義を直接編集します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                システム環境設定 (System Settings)
            </div>
            <!-- Student Roster Board Tab -->
            <div class="nav-item" data-tab="roster_board" title="学籍名簿の管理と取り込みを行います">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                学籍名簿
            </div>
            <!-- Faculty Roster Board Tab -->
            <div class="nav-item" data-tab="faculty_roster" title="教職員名簿の管理と取り込みを行います">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                教職員名簿
            </div>
            <!-- Annual Events Tab -->
            <div class="nav-item" data-tab="annual_events" title="年間の行事予定を確認します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                年間行事予定表
            </div>
            <div class="nav-item" data-tab="help" title="システムのセキュリティと使用上の注意を確認します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                使用上のご注意 (Help)
            </div>
        </aside>

        <section class="content">
            <!-- Dedicated Print Header (Visible only during print) -->
            <div id="print-header" class="print-only">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1.5pt solid #1e293b; padding-bottom: 4px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: baseline; gap: 15px;">
                        <h1 id="print-report-title"
                            style="margin: 0; font-size: 14pt; font-family: 'Noto Sans JP', sans-serif; font-weight: 700; color: #1e293b;">
                            成績管理レポート</h1>
                        <span style="font-size: 8pt; color: #64748b; font-weight: 500;">Academic Record</span>
                    </div>
                    <div style="text-align: right; display: flex; align-items: baseline; gap: 15px;">
                        <div style="font-size: 11pt; font-weight: 700; color: #1e293b;">
                            <span id="print-student-name">-</span>
                        </div>
                        <div style="font-size: 7.5pt; color: #94a3b8;">Issued: <span id="print-date">-</span></div>
                    </div>
                </div>
            </div>

            <!-- Mobile Tab Switcher (visible only on mobile) -->
            <div class="mobile-tabs" style="display: none;">
                <button class="mobile-tab active" data-tab="grades">成績一覧</button>
                <button class="mobile-tab" data-tab="grad_requirements">卒業要件</button>
                <button class="mobile-tab" data-tab="stats">統計</button>
                <button class="mobile-tab" data-tab="stats2">統計2</button>
                <button class="mobile-tab" data-tab="attendance">出欠状況</button>
                <button class="mobile-tab" data-tab="student_summary">サマリー</button>
                <button class="mobile-tab" data-tab="class_stats">クラス成績統計</button>
                <button class="mobile-tab" data-tab="class_attendance_stats">クラス出欠統計</button>
                <button class="mobile-tab" data-tab="at_risk">要注意</button>
                <button class="mobile-tab" data-tab="seating">席決め</button>
                <button class="mobile-tab" data-tab="class_officers">クラス委員</button>
                <button class="mobile-tab" data-tab="timetable">時間割</button>
                <button class="mobile-tab" data-tab="roster_board">学籍名簿</button>
                <button class="mobile-tab" data-tab="faculty_roster">教員名簿</button>
                <button class="mobile-tab" data-tab="settings">システム設定</button>
                <button class="mobile-tab" data-tab="help">ヘルプ</button>
            </div>

            <!-- Grades View -->
            <div id="grades-content" class="tab-content fade-in">
                <!-- Grades Toolbar -->
                <div class="card"
                    style="padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="control-group" title="成績データが入力されていない科目を非表示にします">
                            <input type="checkbox" id="hideEmptySubjects" checked>
                            <label for="hideEmptySubjects"
                                style="font-size: 0.9rem; font-weight: 600; color: #475569;">単位認定のない科目を隠す</label>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button id="saveBtn" class="btn btn-primary" title="現在の成績データをブラウザに保存します">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            保存 (Save)
                        </button>

                        <div style="width: 1px; height: 24px; background: #e2e8f0; margin: 0 0.25rem;"></div>

                        <button id="exportJsonBtn" class="btn btn-secondary" title="成績データをJSON形式でダウンロードします">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            JSON出力
                        </button>
                        <button id="importJsonBtn" class="btn btn-secondary" title="JSONファイルから成績データを読み込みます">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            JSON読込
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">通常科目 (Normal Subjects)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th width="200" title="科目の名称です">授業科目</th>
                                    <th width="60" title="この科目の単位数です">単位</th>
                                    <th width="80" title="必修・選択などの区分です">区分</th>
                                    <th width="80" title="一般・専門などの分類です">分類</th>
                                    <th width="80" title="前期中間試験の点数（クリックで貼付）">前期中間</th>
                                    <th width="80" title="前期末試験の点数（クリックで貼付）">前期末</th>
                                    <th width="80" title="後期中間試験の点数（クリックで貼付）">後期中間</th>
                                    <th width="80" title="学年末試験の点数（クリックで貼付）">学年末</th>
                                </tr>
                            </thead>
                            <tbody id="gradesBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>


                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <div class="card-title">特別学修 (Special Studies)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th width="200" title="科目の名称です">授業科目</th>
                                    <th width="60" title="単位数です">単位</th>
                                    <th width="80" title="必修・選択などの区分です">区分</th>
                                    <th width="80" title="分類です">分類</th>
                                    <th width="80" title="単位認定（修得/認定など）を入力します">認定</th>
                                </tr>
                            </thead>
                            <tbody id="specialGradesBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <div class="card-title">その他 (Others)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th width="200" title="科目の名称です">授業科目</th>
                                    <th width="60" title="単位数です">単位</th>
                                    <th width="80" title="必修・選択などの区分です">区分</th>
                                    <th width="80" title="分類です">分類</th>
                                    <th width="80" title="単位認定（修得/認定など）を入力します">認定</th>
                                </tr>
                            </thead>
                            <tbody id="otherGradesBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Graduation Requirements View -->
            <div id="grad_requirements-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header" style="justify-content: space-between; align-items: center;">
                        <div class="card-title">卒業要件 達成状況 (Graduation Requirements Progress)</div>

                    </div>
                    <div id="gradRequirementsSummary"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">要件別 詳細 (Detailed Requirements)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th title="卒業判定に必要な要件の項目です">要件項目</th>
                                    <th title="必要な単位数などの目標値です">目標</th>
                                    <th title="現在の修得状況です">現在の状況</th>
                                    <th title="目標に対する達成率です">達成度</th>
                                    <th title="要件を満たしているかの判定です">判定</th>
                                </tr>
                            </thead>
                            <tbody id="gradRequirementsDetails">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <div class="card-title">必修得科目 開講スケジュール (Mandatory Subjects Schedule)</div>
                    </div>
                    <div id="mandatoryGanttChartContainer" style="overflow-x: auto; padding: 1rem;">
                        <!-- Gantt Chart will be rendered here -->
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <div class="card-title">DP別 開講スケジュール (DP Schedule)</div>
                    </div>
                    <div id="dpGanttChartContainer" style="overflow-x: auto; padding: 1rem;">
                        <!-- Gantt Chart will be rendered here -->
                    </div>
                    <div
                        style="padding: 1rem; border-top: 1px solid #f1f5f9; display: flex; gap: 1.5rem; font-size: 0.85rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; border-radius: 2px; background: #10b981;"></div>
                            <span>済 (修得済み)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; border-radius: 2px; background: #3b82f6;"></div>
                            <span>未修得 (開講予定)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats View -->
            <div id="stats-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">成績集計 (Summary)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th rowspan="2"
                                        style="min-width:40px; position:sticky; left:0; z-index:2; background:#f8fafc; border-right:1px solid #e2e8f0;">
                                        学年</th>
                                    <th colspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">前期中間</th>
                                    <th colspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">前期末</th>
                                    <th colspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">後期中間</th>
                                    <th colspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">学年末</th>
                                    <th colspan="3" style="text-align:center; border-left:1px solid #e2e8f0;">累計単位</th>
                                    <th colspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">進級判定</th>
                                    <th rowspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">総合順位</th>
                                </tr>
                                <tr>
                                    <!-- Late Mid -->
                                    <th style="min-width:40px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="各試験の平均点です">平均
                                    </th>
                                    <th style="min-width:40px; text-align:center;" title="各試験の順位です">順位</th>
                                    <!-- Late Final -->
                                    <th style="min-width:40px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="各試験の平均点です">平均
                                    </th>
                                    <th style="min-width:40px; text-align:center;" title="各試験の順位です">順位</th>
                                    <!-- Early Mid -->
                                    <th style="min-width:40px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="各試験の平均点です">平均
                                    </th>
                                    <th style="min-width:40px; text-align:center;" title="各試験の順位です">順位</th>
                                    <!-- Early Final -->
                                    <th style="min-width:50px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="各試験の平均点です">平均
                                    </th>
                                    <th style="min-width:50px; text-align:center;" title="各試験の順位です">順位</th>
                                    <!-- Credits -->
                                    <th style="min-width:40px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="一般科目の修得単位数">一般
                                    </th>
                                    <th style="min-width:40px; text-align:center;" title="専門科目の修得単位数">専門</th>
                                    <th style="min-width:40px; text-align:center;" title="合計修得単位数">合計</th>
                                    <!-- Promotion -->
                                    <th style="min-width:40px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="進級に必要な単位数">必要
                                    </th>
                                    <th style="min-width:40px; text-align:center;" title="進級要件に対する不足単位数（プラスなら充足）">過不足
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="statsBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="card chart-container">
                        <div class="card-header"
                            style="margin-bottom:0.5rem; display:flex; justify-content:space-between; align-items:center;">
                            <div class="card-title">クラスの中の成績の位置づけ</div>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <select id="boxPlotYearSelect"
                                    style="padding:0.25rem 0.5rem; border:1px solid #cbd5e1; border-radius:4px;"
                                    title="箱ひげ図に表示する学年を選択">
                                    <option value="">最新</option>
                                    <option value="1">1年</option>
                                    <option value="2">2年</option>
                                    <option value="3">3年</option>
                                    <option value="4">4年</option>
                                    <option value="5">5年</option>
                                </select>
                                <select id="boxPlotTestSelect"
                                    style="padding:0.25rem 0.5rem; border:1px solid #cbd5e1; border-radius:4px;"
                                    title="箱ひげ図に表示する試験を選択">
                                    <option value="">最新</option>
                                    <option value="前期中間">前期中間</option>
                                    <option value="前期末">前期末</option>
                                    <option value="後期中間">後期中間</option>
                                    <option value="学年末">学年末</option>
                                </select>
                            </div>
                        </div>
                        <canvas id="boxPlotChart"></canvas>
                    </div>
                    <div class="card chart-container">
                        <div class="card-header" style="margin-bottom:0.5rem">
                            <div class="card-title">成績・順位推移 (Trend)</div>
                        </div>
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stats2 View -->
            <div id="stats2-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header" style="justify-content: space-between;">
                        <div class="card-title">累積評点平均 & GPA (Cumulative Average & GPA)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th width="80">学年</th>
                                    <th width="80" style="text-align:center;">科目数</th>
                                    <th width="120" style="text-align:center;">平均点<br><span
                                            style="font-size:0.8em; font-weight:normal">(単純)</span></th>
                                    <th width="80" style="text-align:center;">順位</th>
                                    <th width="120" style="text-align:center;">平均点<br><span
                                            style="font-size:0.8em; font-weight:normal">(加重)</span></th>
                                    <th width="80" style="text-align:center;">順位</th>
                                    <th width="100" style="text-align:center;">GPA</th>
                                    <th width="80" style="text-align:center;">順位</th>
                                </tr>
                            </thead>
                            <tbody id="stats2Body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="no-print-text" style="padding: 1rem; color: #64748b; font-size: 0.85rem;">
                        ※ 各学年までの最新の評点(学年末を含む)の累積データです。<br>
                        ※ 平均点(単純): 合計点 / 科目数<br>
                        ※ 平均点(加重): Σ(点数×単位数) / Σ単位数<br>
                        ※ GPA: Σ(GP×単位数) / Σ単位数 (S:90~=4, A:80~=3, B:70~=2, C:60~=1, D/F:~59=0)
                    </div>
                    <div class="charts-grid" style="margin-top: 1.5rem;">
                        <div class="chart-container"
                            style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; height: 350px;">
                            <canvas id="stats2SimpleChart"></canvas>
                        </div>
                        <div class="chart-container"
                            style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; height: 350px;">
                            <canvas id="stats2WeightedChart"></canvas>
                        </div>
                        <div class="chart-container"
                            style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; height: 350px;">
                            <canvas id="stats2GpaChart"></canvas>
                        </div>
                    </div>

                    <!-- Old Class Statistics Section Removed -->
                </div>
            </div>

            <!-- Class Statistics View -->
            <div id="class_stats-content" class="tab-content hidden fade-in">
                <style>
                    .sub-nav {
                        display: flex;
                        gap: 0.5rem;
                        border-bottom: 2px solid #e2e8f0;
                        margin-bottom: 1.5rem;
                    }

                    .sub-nav-item {
                        padding: 0.75rem 1.25rem;
                        font-weight: 600;
                        font-size: 0.9rem;
                        color: #64748b;
                        border: none;
                        background: none;
                        cursor: pointer;
                        border-bottom: 2px solid transparent;
                        margin-bottom: -2px;
                        transition: all 0.2s;
                    }

                    .sub-nav-item:hover {
                        color: var(--primary);
                    }

                    .sub-nav-item.active {
                        color: var(--primary);
                        border-bottom-color: var(--primary);
                    }
                </style>
                <div class="card">
                    <div class="card-header" style="flex-direction: column; align-items: flex-start; gap: 1rem;">
                        <h2 class="card-title">クラス統計 (Class Statistics)</h2>
                        <div class="sub-nav no-print">
                            <button class="sub-nav-item active" data-cs-tab="grade">成績統計</button>
                            <button class="sub-nav-item" data-cs-tab="attendance">出欠統計</button>
                        </div>
                    </div>

                    <!-- Grade Stats Sub-Section -->
                    <div id="cs-tab-grade" class="cs-tab-content">
                        <div style="margin-top: 1rem;">
                            <p style="margin-bottom:1rem; color:#64748b; font-size:0.9rem;">
                                指定した学年・テスト時点でのクラス全員の成績一覧表を作成します。<br>
                                「統計・グラフ1」の平均点および「統計・グラフ2」の累積評価（単純・加重・GPA）とそれぞれの順位を表示します。
                            </p>
                            <div
                                style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; border:1px solid #e2e8f0;">
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label style="font-size: 0.95rem; font-weight: 600;">対象学年:</label>
                                    <select id="classStatsYear"
                                        style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.3rem; min-width:80px;">
                                        <option value="1">1年</option>
                                        <option value="2">2年</option>
                                        <option value="3">3年</option>
                                        <option value="4">4年</option>
                                        <option value="5">5年</option>
                                    </select>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label style="font-size: 0.95rem; font-weight: 600;">時点(テスト):</label>
                                    <select id="classStatsTest"
                                        style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.3rem; min-width:100px;">
                                        <option value="前期中間">前期中間</option>
                                        <option value="前期末">前期末</option>
                                        <option value="後期中間">後期中間</option>
                                        <option value="学年末">学年末</option>
                                    </select>
                                </div>
                                <button id="generateClassStatsBtn" class="btn btn-primary"
                                    style="padding: 0.5rem 1rem;">
                                    帳票作成 (Generate Report)
                                </button>
                                <button id="exportClassStatsCsvBtn" class="btn-secondary" style="padding: 0.5rem 1rem;">
                                    CSV出力
                                </button>
                            </div>
                            <div id="classStatsContainer" style="margin-top: 2rem; overflow-x: auto;"></div>
                        </div>
                    </div>

                    <!-- Attendance Stats Sub-Section -->
                    <div id="cs-tab-attendance" class="cs-tab-content hidden">
                        <div style="margin-top: 1rem;">
                            <p style="margin-bottom:1rem; color:#64748b; font-size:0.9rem;">
                                クラス全員の出欠状況を集計します。累積の欠席・遅刻・早退数を一覧表示し、傾向を把握します。
                            </p>
                            <div
                                style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; border:1px solid #e2e8f0;">
                                <button id="generateClassAttendanceStatsBtn" class="btn btn-primary"
                                    style="padding: 0.5rem 1rem;">
                                    出欠集計実行 (Generate Attendance Report)
                                </button>
                                <button id="exportClassAttendanceCsvBtn" class="btn-secondary"
                                    style="padding: 0.5rem 1rem;">
                                    CSV出力
                                </button>
                            </div>
                            <div id="classAttendanceStatsContainer" style="margin-top: 2rem; overflow-x: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Summary View -->
            <div id="student_summary-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header" style="justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <h2 class="card-title">学生サマリー (Individual Student Summary)</h2>
                        <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;"
                            class="no-print">

                            <div class="control-group">
                                <label>対象学年:</label>
                                <select id="summaryYearSelect" onchange="renderStudentSummary()">
                                    <option value="1">1年</option>
                                    <option value="2">2年</option>
                                    <option value="3">3年</option>
                                    <option value="4">4年</option>
                                    <option value="5">5年</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>対象試験:</label>
                                <select id="summaryTestSelect" onchange="renderStudentSummary()">
                                    <option value="前期中間">前期中間</option>
                                    <option value="前期末" selected>前期末</option>
                                    <option value="後期中間">後期中間</option>
                                    <option value="学年末">学年末</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" onclick="window.print()">この学生を印刷 (Print One)</button>
                            <button class="btn btn-primary" onclick="printAllStudentSummaries()">クラス全員を一括印刷 (Batch Print
                                All)</button>
                        </div>
                    </div>
                    <div id="studentSummaryArea" style="min-height: 400px; padding: 1rem; background: #fff;">
                        <div style="text-align: center; padding: 5rem; color: #94a3b8;">
                            学生を選択してください。
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Attendance Gantt View -->
            <div id="class_attendance_stats-content" class="tab-content hidden fade-in">
                <div class="card" style="padding: 1.5rem; overflow: hidden; display: flex; flex-direction: column;">
                    <div class="card-header"
                        style="justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                        <div class="card-title">クラス全体出欠状況統計 (Class Attendance Gantt)</div>
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;" class="no-print">
                            <div class="control-group" style="display: flex; gap: 0.5rem; align-items: center;">
                                <button class="btn btn-secondary" onclick="navigateClassAttendanceGantt(-1)"
                                    style="padding: 0.3rem 0.6rem;">◀</button>
                                <button class="btn btn-primary" onclick="jumpToTodayClassAttendanceGantt()"
                                    style="padding: 0.3rem 0.8rem; font-size: 0.85rem;">今日 (Today)</button>
                                <button class="btn btn-secondary" onclick="navigateClassAttendanceGantt(1)"
                                    style="padding: 0.3rem 0.6rem;">▶</button>
                            </div>
                            <div class="control-group">
                                <label for="classAttendanceRangeSelect">表示範囲:</label>
                                <select id="classAttendanceRangeSelect" style="width: 80px;"
                                    onchange="renderClassAttendanceStats()">
                                    <option value="7">7日間</option>
                                    <option value="15">15日間</option>
                                    <option value="30" selected>30日間</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="classAttendanceTargetDate">基準日:</label>
                                <input type="date" id="classAttendanceTargetDate" style="width: 140px;"
                                    onchange="renderClassAttendanceStats()">
                            </div>
                        </div>
                    </div>

                    <div id="classAttendanceGanttWrapper"
                        style="position: relative; border: 1px solid var(--border); border-radius: 0.5rem; background: #f8fafc; overflow: auto; max-height: 75vh;">
                        <table id="classAttendanceGanttTable"
                            style="border-collapse: separate; border-spacing: 0; min-width: 100%; width: max-content; table-layout: fixed; background: white;">
                            <thead style="position: sticky; top: 0; z-index: 30;">
                                <tr id="classAttendanceGanttHeader">
                                    <!-- JSで動的に生成 -->
                                </tr>
                            </thead>
                            <tbody id="classAttendanceGanttBody">
                                <!-- JSで動的に生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- At Risk Students View -->
            <div id="at_risk-content" class="tab-content hidden fade-in">

                <div class="card">
                    <div class="card-header" style="justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <h2 class="card-title">要注意学生の抽出 (Risk Student Extraction)</h2>

                        <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;"
                            class="no-print">
                            <div class="control-group">
                                <label>抽出基準:</label>
                                <select id="atRiskTypeSelect" onchange="toggleAtRiskInputs()">
                                    <option value="test">試験1回ごとの成績</option>
                                    <option value="year_avg">科目ごとの通年平均</option>
                                    <option value="attendance_abs">1. 欠席密度 (科目・時限別)</option>
                                    <option value="attendance_lat">2. 遅刻特化 (連続・高頻度遅刻)</option>
                                    <option value="attendance_pattern">3. 行動傾向 (連続欠席・曜日別)</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>学年:</label>
                                <select id="atRiskYearSelect">
                                    <option value="1">1年</option>
                                    <option value="2">2年</option>
                                    <option value="3">3年</option>
                                    <option value="4">4年</option>
                                    <option value="5">5年</option>
                                </select>
                            </div>
                            <div class="control-group" id="atRiskTestWrapper">
                                <label>対象試験:</label>
                                <select id="atRiskTestSelect">
                                    <option value="前期中間">前期中間</option>
                                    <option value="前期末" selected>前期末</option>
                                    <option value="後期中間">後期中間</option>
                                    <option value="学年末">学年末</option>
                                </select>
                            </div>
                            <div class="control-group hidden" id="atRiskAttendanceWrapper"
                                style="gap: 1.5rem; display: none;">
                                <div style="display:flex; align-items:center; gap:0.5rem;">
                                    <label style="white-space:nowrap;">欠席回数以上:</label>
                                    <input type="number" id="atRiskAbsLimit" value="15" min="1"
                                        style="width: 60px; padding: 0.3rem;">
                                </div>
                                <div style="display:flex; align-items:center; gap:0.5rem;">
                                    <label style="white-space:nowrap;">遅刻回数以上:</label>
                                    <input type="number" id="atRiskLatLimit" value="20" min="1"
                                        style="width: 60px; padding: 0.3rem;">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="renderAtRiskReport()">抽出実行</button>
                        </div>
                    </div>
                    <div id="atRiskInstructions" class="no-print"
                        style="margin-bottom: 1.5rem; padding: 1rem; background: #fff1f2; border-radius: 0.5rem; color: #991b1b; font-size: 0.85rem; border: 1px solid #fecaca;">
                        <div id="instr-test">
                            <strong>【試験1回ベース】</strong> 以下のいずれかに該当する学生を抽出：<br>
                            ・59点以下が4科目以上 / ・49点以下が3科目以上 / ・39点以下が2科目以上
                        </div>
                        <div id="instr-year_avg" class="hidden">
                            <strong>【通年平均ベース】</strong> 以下のいずれかに該当する学生を抽出：<br>
                            ・平均59点以下が3科目以上 / ・平均49点以下が2科目以上 / ・平均39点以下が1科目以上
                        </div>
                        <div id="instr-attendance_abs" class="hidden">
                            <strong>【1. 欠席密度フィルタ】</strong> 欠席換算(2遅刻=1欠)ポイントで判定：<br>
                            ① 特定科目 10pt以上で抽出 (10pt:黄 / 25%超:橙 / 30%超:赤 / 33%~:黒)<br>
                            ② 特定時限 密度判定 / ③ 全科目 累積密度
                        </div>
                        <div id="instr-attendance_lat" class="hidden">
                            <strong>【2. 遅刻特化フィルタ】</strong> 偶発的な遅刻も含む回数ベース。基準を調整：<br>
                            ① 科目別 遅刻回数（2回以上:黄 / 3回以上:橙 / 4回以上:赤）<br>
                            ② 特定曜日の遅刻（同じ曜日に3回以上）<br>
                            ③ 累積 遅刻総数（5回以上:黄 / 10回以上:橙）
                        </div>
                        <div id="instr-attendance_pattern" class="hidden">
                            <strong>【3. 行動傾向フィルタ】</strong> 欠席・遅刻の出現パターン：<br>
                            ① 連続欠席（3日:黄 / 5日:橙 / 7日:赤 / 8日~:黒）<br>
                            ② 特定曜日に欠席・遅刻が集中（3回以上で抽出）
                        </div>
                    </div>
                    <div id="atRiskReportArea">
                        <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                            条件を選択して「抽出実行」をクリックしてください。
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seating Assignment View -->
            <div id="seating-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header"
                        style="justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <h2 class="card-title">席決め (Seating Assignment)</h2>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;" class="no-print">
                            <div class="control-group">
                                <label>列:</label>
                                <input type="number" id="seatingCols" value="7" min="1" max="20" style="width: 60px;">
                            </div>
                            <div class="control-group">
                                <label>行:</label>
                                <input type="number" id="seatingRows" value="7" min="1" max="20" style="width: 60px;">
                            </div>
                            <div class="control-group">
                                <label>視点:</label>
                                <select id="seatingPerspective" style="width: 100px;">
                                    <option value="teacher">教員</option>
                                    <option value="student">学生</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" id="updateSeatingGridBtn">グリッド更新</button>
                            <div class="divider-v"></div>
                            <div class="control-group">
                                <label>配置:</label>
                                <select id="seatingAssignMethod" style="width: 130px;">
                                    <option value="random">ランダム</option>
                                    <option value="roster_v">名簿順 (縦)</option>
                                    <option value="roster_h">名簿順 (横)</option>
                                    <option value="grades_asc">成績順 (前=低)</option>
                                    <option value="attendance_desc">出欠順 (前=多)</option>
                                </select>
                                <button class="btn btn-primary" id="autoAssignBtn">実行</button>
                            </div>
                            <button class="btn btn-secondary" id="clearSeatingBtn">クリア</button>
                            <div class="divider-v"></div>
                            <div class="control-group">
                                <label>プリセット:</label>
                                <select id="seatingPresetSelect" style="width: 150px;">
                                    <option value="">-- 選択 --</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" id="savePresetBtn">プリセット保存</button>
                            <button class="btn btn-secondary" id="deletePresetBtn">削除</button>
                            <div class="divider-v"></div>
                            <button class="btn btn-secondary" id="saveSeatingBtn">保存</button>
                            <button class="btn btn-secondary" id="loadSeatingBtn">読込</button>
                            <button class="btn btn-secondary" id="exportSeatingPdfBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                </svg>
                                <span>PDF</span>
                            </button>
                            <div class="control-group" style="margin-left: 0.5rem;">
                                <label>PDF色:</label>
                                <input type="color" id="seatingPdfColor" value="#eef2ff"
                                    style="width: 50px; height: 32px; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer;">
                            </div>
                            <div class="divider-v"></div>
                            <div class="control-group">
                                <label>色分け:</label>
                                <select id="seatingColorMode" style="width: 130px;">
                                    <option value="none">なし</option>
                                    <option value="grade">成績（平均点）</option>
                                    <option value="attendance">出欠（遅刻欠席）</option>
                                </select>
                            </div>
                            <div class="control-group" id="seatingGradeMethodWrapper">
                                <label>計算方法:</label>
                                <select id="seatingGradeMethod" style="width: 140px;">
                                    <option value="cumulative">単純平均（累積）</option>
                                    <option value="latest">最新テストの平均</option>
                                </select>
                            </div>
                            <div id="seatingGradeMethodInfo"
                                style="font-size: 0.75rem; color: #64748b; margin-left: 0.5rem;"></div>
                        </div>
                    </div>

                    <div class="seating-wrapper"
                        style="display: grid; grid-template-columns: 280px 1fr; gap: 1.5rem; margin-top: 1rem;">
                        <!-- Roster Sidebar -->
                        <div class="seating-roster-sidebar"
                            style="background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0; padding: 1rem; height: 600px; display: flex; flex-direction: column;">
                            <h3 style="font-size: 0.95rem; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">名簿
                                (学生リスト)</h3>
                            <div id="seatingCountInfo"
                                style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.75rem; padding: 0.5rem; background: #fff; border-radius: 0.3rem; border: 1px solid #e2e8f0;">
                                <!-- Populated by JS -->
                            </div>
                            <div id="seatingRosterList"
                                style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.25rem;">
                                <!-- Populated by JS -->
                            </div>
                            <div style="margin-top: 1rem; font-size: 0.8rem; color: #64748b;">
                                ※ 学生をドラッグして席に配置できます。<br>
                                ※ 右クリックで固定・解除が可能です。
                            </div>
                        </div>

                        <!-- Seating Grid -->
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div id="seatingDesk"
                                style="text-align: center; background: #e2e8f0; padding: 0.5rem; border-radius: 0.3rem; font-weight: bold; color: #475569;">
                                教 卓 (前方)
                            </div>
                            <div id="seatingGridContainer" class="seating-grid-container"
                                style="background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; overflow: auto; min-height: 500px;">
                                <!-- Grid Canvas or Div-based Grid -->
                                <div id="seatingGrid" style="display: grid; gap: 10px; justify-content: center;">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Roster Board View (Replaces specific modal) -->
            <div id="faculty_roster-content" class="tab-content hidden fade-in">
                <div class="card" style="height: calc(100vh - 140px); display: flex; flex-direction: column;">
                    <div class="card-header"
                        style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div class="card-title">教職員名簿 (Faculty Roster)</div>
                        <div style="display: flex; gap: 1.5rem; align-items: center;">
                            <!-- Communication Group -->
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="font-size: 0.85rem; font-weight: 600; color: #64748b;">連絡:</span>
                                <button id="facultyTeamsChatBtn" class="btn btn-secondary"
                                    style="border: 1px solid #cbd5e1; color: #4f46e5; background: #eef2ff;">
                                    Teams
                                </button>
                                <button id="facultySendMailBtn" class="btn btn-secondary"
                                    style="border: 1px solid #cbd5e1; color: #0891b2; background: #ecfeff;">
                                    メール
                                </button>
                            </div>

                            <!-- Import/Register Group -->
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="font-size: 0.85rem; font-weight: 600; color: #64748b;">読込:</span>
                                <input type="file" id="facultyFileInput" accept=".csv" style="display: none;">

                            </div>
                        </div>
                    </div>

                    <!-- Board Layout -->
                    <div style="flex: 1; display: grid; grid-template-columns: 240px 1fr; gap: 1.5rem; min-height: 0;">
                        <!-- Sidebar: Filters & Info -->
                        <div
                            style="background: #f8fafc; border-radius: 0.6rem; padding: 1rem; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 1.2rem; overflow-y: auto;">
                            <div>
                                <div
                                    style="font-size: 0.8rem; font-weight: 700; color: #475569; margin-bottom: 0.8rem;">
                                    絞り込み</div>
                                <div class="control-group" style="margin-bottom: 1rem;">
                                    <input type="text" id="facultySearchInput" placeholder="氏名・IDで検索..."
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; font-size: 0.85rem;">
                                </div>
                                <div id="facultyFilterContainer"
                                    style="display: flex; flex-direction: column; gap: 1rem;">
                                    <!-- Populated by JS -->
                                </div>
                                <button id="clearFacultyFiltersBtn" class="btn btn-secondary"
                                    style="width: 100%; margin-top: 1rem; justify-content: center; font-size: 0.85rem;">
                                    🔄 絞り込みクリア
                                </button>
                            </div>

                            <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                                <div id="facultyBoardStatus"
                                    style="font-size: 0.85rem; font-weight: 600; color: #64748b;">
                                    ファイル未選択</div>
                            </div>
                        </div>

                        <!-- Main Table Area -->
                        <div class="table-container" style="border: 1px solid #e2e8f0; border-radius: 0.6rem;">
                            <table class="roster-table" style="font-size: 0.85rem;">
                                <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 20;">
                                    <tr>
                                        <th style="width: 40px; text-align: center;">
                                            <input type="checkbox" id="facultySelectAll">
                                        </th>
                                        <th style="width: 120px;">所属</th>
                                        <th style="width: 150px;">校務分掌１</th>
                                        <th style="width: 150px;">校務分掌２</th>
                                        <th style="width: 120px;">氏名</th>
                                        <th style="width: 200px;">OMUメール</th>
                                        <th style="width: 100px;">OMU ID</th>
                                        <th style="width: 80px; text-align: center;">連絡</th>
                                    </tr>
                                </thead>
                                <tbody id="facultyRosterBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="roster_board-content" class="tab-content hidden fade-in">
                <div class="card" style="height: calc(100vh - 140px); display: flex; flex-direction: column;">
                    <div class="card-header"
                        style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div class="card-title">名簿管理・取り込み (Roster Management)</div>
                        <div style="display: flex; gap: 1.5rem; align-items: center;">
                            <!-- Communication Group -->
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="font-size: 0.85rem; font-weight: 600; color: #64748b;">連絡:</span>
                                <button id="teamsChatSelectedBtn" class="btn btn-secondary"
                                    style="border: 1px solid #cbd5e1; color: #4f46e5; background: #eef2ff;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="16" height="16"
                                        style="margin-right: 0.4rem;">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                    Teams
                                </button>
                                <button id="sendMailSelectedBtn" class="btn btn-secondary"
                                    style="border: 1px solid #cbd5e1; color: #0891b2; background: #ecfeff;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="16" height="16"
                                        style="margin-right: 0.4rem;">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                    メール
                                </button>
                            </div>

                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="font-size: 0.85rem; font-weight: 600; color: #64748b;">登録実行:</span>
                                <!-- Action Buttons -->
                                <button id="applyRosterImportBtn" class="btn btn-primary" style="background:#10b981;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="18" height="18">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>
                                    登録実行
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Board Layout -->
                    <div
                        style="display: grid; grid-template-columns: 250px 1fr; gap: 1.5rem; flex: 1; overflow: hidden;">
                        <!-- Left Panel: Filter & Status -->
                        <div
                            style="background: #f8fafc; border-right: 1px solid #e2e8f0; padding: 1rem; display: flex; flex-direction: column; gap: 1.5rem;">
                            <div
                                style="background: #eef2ff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #c7d2fe;">
                                <h4 style="font-size: 0.9rem; font-weight: 600; color: #3730a3; margin-bottom: 0.5rem;">
                                    現在のステータス</h4>
                                <div id="rosterBoardStatus" style="font-size: 0.85rem; color: #4338ca;">
                                    ファイル未読み込み
                                </div>
                            </div>

                            <div id="rosterBoardFilters">
                                <h4
                                    style="font-size: 0.9rem; font-weight: 600; color: #475569; margin-bottom: 1rem; border-bottom: 1px solid #cbd5e1; padding-bottom: 0.5rem;">
                                    絞り込み条件</h4>
                                <div class="control-group" style="margin-bottom: 1rem;">
                                    <input type="text" id="rosterSearchInput" placeholder="氏名・番号で検索..."
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; font-size: 0.85rem;">
                                </div>
                                <!-- Dynamic Filters Helper -->
                                <div id="rosterFilterContainer"
                                    style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="color: #94a3b8; font-size: 0.85rem;">ファイルを読み込むと条件が表示されます</div>
                                </div>
                                <button id="clearRosterFiltersBtn" class="btn btn-secondary"
                                    style="width: 100%; margin-top: 1rem; justify-content: center; font-size: 0.85rem;">
                                    🔄 絞り込みクリア
                                </button>
                            </div>

                            <div style="margin-top: auto;">
                                <div class="control-group">
                                    <label>並び順:</label>
                                    <select id="rosterSortSelect"
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.4rem;">
                                        <option value="original">ファイル順</option>
                                        <option value="studentId">学籍番号順</option>
                                        <option value="name">氏名順</option>
                                        <option value="year">学年順</option>
                                        <option value="class">組順</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Right Panel: Data Table -->
                        <div class="table-container"
                            style="overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem; background: white;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead
                                    style="position: sticky; top: 0; background: #f1f5f9; z-index: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                    <tr>
                                        <th style="width: 40px; text-align: center; padding: 0.5rem 0.25rem;">
                                            <input type="checkbox" id="rosterSelectAll" style="cursor: pointer;">
                                        </th>
                                        <th class="sortable-th" data-sort="year"
                                            style="text-align: left; padding: 0.5rem; cursor: pointer;">学年 <span
                                                class="sort-icon"></span></th>
                                        <th class="sortable-th" data-sort="class"
                                            style="text-align: left; padding: 0.5rem; cursor: pointer;">クラス <span
                                                class="sort-icon"></span></th>
                                        <th class="sortable-th" data-sort="no"
                                            style="text-align: left; padding: 0.5rem; cursor: pointer;">番号 <span
                                                class="sort-icon"></span></th>
                                        <th class="sortable-th" data-sort="name"
                                            style="text-align: left; padding: 0.5rem; cursor: pointer;">氏名 <span
                                                class="sort-icon"></span></th>
                                        <th style="text-align: left; padding: 0.5rem; color:#94a3b8; font-size:0.8rem;">
                                            暗号化氏名1</th>
                                        <th class="sortable-th" data-sort="omuid"
                                            style="text-align: left; padding: 0.5rem; cursor: pointer;">OMUID <span
                                                class="sort-icon"></span></th>
                                        <th style="text-align: center; padding: 0.5rem; width: 60px;">連絡</th>
                                        <th class="sortable-th" data-sort="gender"
                                            style="text-align: left; padding: 0.5rem; cursor: pointer;">性別 <span
                                                class="sort-icon"></span></th>
                                        <th class="sortable-th" data-sort="selection"
                                            style="text-align: left; padding: 0.5rem; cursor: pointer;">選択 <span
                                                class="sort-icon"></span></th>
                                        <th class="sortable-th" data-sort="course"
                                            style="text-align: left; padding: 0.5rem; cursor: pointer;">応用専門分野・領域 <span
                                                class="sort-icon"></span></th>
                                        <th class="sortable-th" data-sort="status"
                                            style="text-align: center; padding: 0.5rem; cursor: pointer;">ステータス <span
                                                class="sort-icon"></span></th>
                                    </tr>
                                </thead>
                                <tbody id="rosterBoardBody">
                                    <tr>
                                        <td colspan="11" style="text-align: center; padding: 3rem; color: #94a3b8;">
                                            「新しい名簿ファイルを読み込む」ボタンからCSVを選択してください
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timetable Editor View -->
            <div id="timetable-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header"
                        style="justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div class="card-title">クラス時間割エディター (Class Timetable Editor)</div>
                        <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                            <div class="control-group">
                                <label for="timetableSemester">学期:</label>
                                <select id="timetableSemester" style="min-width: 120px;">
                                    <option value="前期">前期 (4月-9月)</option>
                                    <option value="後期">後期 (10月-3月)</option>
                                </select>
                            </div>
                            <button id="clearTimetableBtn" class="btn btn-danger" style="background: #ef4444;"
                                title="表示中の学期の時間をすべて消去します">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                全消去
                            </button>
                            <button id="saveTimetableBtn" class="btn btn-primary" title="時間割データを保存します">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                                保存
                            </button>
                            <button id="exportTimetablePdfBtn" class="btn btn-secondary" title="時間割をPDF出力します">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                </svg>
                                PDF出力
                            </button>
                            <button id="exportTimetableJsonBtn" class="btn btn-secondary"
                                title="時間割データをJSON形式でエクスポートします">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                JSON出力
                            </button>
                            <button id="importTimetableJsonBtn" class="btn btn-secondary"
                                title="時間割データをJSON形式でインポートします">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                JSON読込
                            </button>
                        </div>
                    </div>

                    <div style="padding: 1.5rem;">
                        <div style="margin-bottom: 1rem; color: #64748b; font-size: 0.9rem;">
                            <p style="margin-bottom: 0.5rem;">
                                <strong>使い方:</strong>
                                各セルをクリックして選択（青枠）し、<strong>Ctrl+C (コピー)</strong>, <strong>Ctrl+X (切り取り)</strong>,
                                <strong>Ctrl+V (貼り付け)</strong> が可能です。
                                選択したセルを再度クリック、またはダブルクリックで編集画面が開きます。
                                選択の解除は <strong>Escキー</strong> で行えます。
                            </p>
                        </div>

                        <!-- Timetable Grid -->
                        <div style="overflow-x: auto;">
                            <table id="timetableGrid"
                                style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <thead>
                                    <tr
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                        <th
                                            style="padding: 1rem; text-align: center; font-weight: 600; border: 1px solid #e2e8f0; min-width: 100px;">
                                            時限</th>
                                        <th
                                            style="padding: 1rem; text-align: center; font-weight: 600; border: 1px solid #e2e8f0; min-width: 150px;">
                                            月</th>
                                        <th
                                            style="padding: 1rem; text-align: center; font-weight: 600; border: 1px solid #e2e8f0; min-width: 150px;">
                                            火</th>
                                        <th
                                            style="padding: 1rem; text-align: center; font-weight: 600; border: 1px solid #e2e8f0; min-width: 150px;">
                                            水</th>
                                        <th
                                            style="padding: 1rem; text-align: center; font-weight: 600; border: 1px solid #e2e8f0; min-width: 150px;">
                                            木</th>
                                        <th
                                            style="padding: 1rem; text-align: center; font-weight: 600; border: 1px solid #e2e8f0; min-width: 150px;">
                                            金</th>
                                    </tr>
                                </thead>
                                <tbody id="timetableBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Legend -->
                        <div
                            style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #1e293b;">時間割:</div>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.85rem; color: #64748b;">
                                <div>1限: 9:00～9:45</div>
                                <div>2限: 9:50～10:35</div>
                                <div>3限: 10:45～11:30</div>
                                <div>4限: 11:35～12:20</div>
                                <div>5限: 13:05～13:50</div>
                                <div>6限: 13:55～14:40</div>
                                <div>7限: 14:50～15:35</div>
                                <div>8限: 15:40～16:25</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Annual Events View -->
            <div id="annual_events-content" class="tab-content hidden fade-in">
                <div class="card" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem;">
                    <div class="card-header" style="justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h2 class="card-title">年間行事予定表 (Annual Event Calendar)</h2>
                            <p style="font-size: 0.85rem; color: #64748b; margin-top: 0.25rem;">学校行事・試験予定をカレンダー形式で表示します。
                            </p>
                        </div>
                        <div style="display: flex; gap: 0.75rem; align-items: center;" class="no-print">
                            <div class="control-group" style="display: flex; gap: 0.25rem;">
                                <button class="btn btn-secondary" onclick="navigateAnnualEventMonth(-1)"
                                    style="padding: 0.3rem 0.6rem;" title="前月">◀</button>
                                <button class="btn btn-primary" onclick="jumpToTodayAnnualEvent()"
                                    style="padding: 0.3rem 0.8rem; font-size: 0.85rem;">今日 (Today)</button>
                                <button class="btn btn-secondary" onclick="navigateAnnualEventMonth(1)"
                                    style="padding: 0.3rem 0.6rem;" title="次月">▶</button>
                            </div>
                            <div class="control-group">
                                <label>表示年度:</label>
                                <select id="eventYearSelect" onchange="renderAnnualEvents()" style="min-width: 100px;">
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div class="control-group">
                                <label>表示月:</label>
                                <select id="eventMonthSelect" onchange="renderAnnualEvents()" style="min-width: 80px;">
                                    <option value="4">4月</option>
                                    <option value="5">5月</option>
                                    <option value="6">6月</option>
                                    <option value="7">7月</option>
                                    <option value="8">8月</option>
                                    <option value="9">9月</option>
                                    <option value="10">10月</option>
                                    <option value="11">11月</option>
                                    <option value="12">12月</option>
                                    <option value="1">1月</option>
                                    <option value="2">2月</option>
                                    <option value="3">3月</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" onclick="exportAnnualEventsCsv()" title="CSVとして出力">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l4-4m-4 4V4" />
                                </svg>
                                CSV出力
                            </button>
                        </div>
                    </div>

                    <div id="annualEventCalendar" class="calendar-grid-container"
                        style="background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden;">
                        <!-- Calendar Rendered by JS -->
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-content" class="tab-content hidden fade-in">
                <!-- Data Management Header -->
                <div class="card" style="margin-bottom: 2rem; background: var(--primary); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="font-size: 1.5rem; margin-bottom: 0.25rem;">マスタデータ管理</h2>
                            <p style="opacity: 0.9; font-size: 0.9rem;">学生名や科目定義の全般的な管理を行います。</p>
                        </div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button id="fullBackupBtn" class="btn" onclick="exportJson()"
                                style="background: #10b981; color: white; border: none; font-weight: bold;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                <span>全データ一括バックアップ (Export All)</span>
                            </button>
                            <button id="fullRestoreBtn" class="btn"
                                onclick="document.getElementById('jsonFileInput').click()"
                                style="background: #f59e0b; color: white; border: none; font-weight: bold;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l4 4m-4-4h12" />
                                </svg>
                                <span>全データ一括復元 (Import All)</span>
                            </button>
                            <div style="width: 2px; background: rgba(255,255,255,0.3); margin: 0 0.5rem;"
                                class="no-mobile"></div>
                            <button id="changePassBtn" class="btn"
                                style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                                </svg>
                                <span>パスワード変更</span>
                            </button>
                            <button id="clearAllDataBtn" class="btn"
                                style="background: #ef4444; color: white; border: 1px solid #b91c1c;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                <span>全データリセット</span>
                            </button>
                            <button id="restoreDefaultsBtn" class="btn"
                                style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                <span>科目の初期化 (Subjects Only)</span>
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 1.5rem;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: white; font-weight: 600;">基本設定
                            (General Settings)</h3>
                        <div
                            style="display: flex; gap: 2rem; flex-wrap: wrap; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.5rem;">
                            <!-- Data Range -->
                            <div class="control-group" title="データの集計対象範囲を切り替えます">
                                <label
                                    style="color: rgba(255,255,255,0.9); display:block; margin-bottom:0.3rem; font-size: 0.85rem;">データ集計範囲:</label>
                                <div style="display:flex; gap:0.5rem;">
                                    <select id="dataRangeSelect"
                                        style="width: 100px; color: #1e40af; font-weight: 600; padding: 0.3rem; border-radius: 0.25rem; border: none;">
                                        <option value="single">単年度</option>
                                        <option value="all">全期間</option>
                                    </select>
                                    <select id="fiscalYearSelect"
                                        style="width: 100px; padding: 0.3rem; border-radius: 0.25rem; border: none; color: #1e293b;"
                                        title="出欠集計の対象年度">
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                            </div>
                            <!-- Name Display -->
                            <div class="control-group">
                                <label
                                    style="color: rgba(255,255,255,0.9); display:block; margin-bottom:0.3rem; font-size: 0.85rem;">アプリ内表示名:</label>
                                <select id="settingNameDisplay" onchange="updateNameDisplayMode(this.value)"
                                    style="width: 200px; padding: 0.3rem; border-radius: 0.25rem; border: none; font-size: 0.9rem; color: #1e293b;">
                                    <option value="name">氏名 (Full Name)</option>
                                    <option value="initial">イニシャル/暗号化 (Anonymized)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div
                        style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; font-size: 0.9rem;">
                        <ul style="list-style-type: disc; margin-left: 1.5rem; line-height: 1.6;">
                            <li><strong>全データリセット (Clear):</strong> 成績データ、学生リスト、変更した科目定義など、<span
                                    style="color: #fecaca; font-weight: bold;">全てのデータを消去</span>して工場出荷時に戻します。</li>
                            <li><strong>科目の初期化 (Reset Subjects):</strong> 成績データや学生リストは<span
                                    style="color: #bfdbfe; font-weight: bold;">保持したまま</span>、科目定義（単位数や必修区分など）のみを初期値に戻します。科目を間違って削除してしまった場合などに使用します。
                            </li>
                            <li><strong>パスワード変更:</strong> ログイン用のパスワードを変更します。</li>
                        </ul>
                    </div>
                    <div style="margin-top: 1rem; text-align: right;">
                        <button id="finalSaveSettingsBtn" class="btn"
                            style="background: white; color: var(--primary); font-weight: bold; border: none; margin-left: auto;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            <span>すべての変更を確定保存 (Global Save)</span>
                        </button>
                    </div>
                </div>

                <!-- System Resource Files Card -->
                <div class="card" style="margin-top: 2rem; border: 2px solid #eef2ff;">
                    <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                        <div class="card-title"
                            style="color: #1e40af; display: flex; align-items: center; gap: 0.5rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            システム構成ファイルの読み込み (External Data Import)
                        </div>
                    </div>
                    <div class="card-body">
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                            <!-- Student Roster -->
                            <div
                                style="background: #fff; padding: 1.25rem; border-radius: 0.8rem; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div
                                        style="width: 32px; height: 32px; background: #eef2ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #4f46e5;">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor" stroke-width="2" width="18" height="18">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                        </svg>
                                    </div>
                                    <h4 style="font-size: 1rem; font-weight: 600; color: #334155; margin: 0;">
                                        学籍名簿ファイル</h4>
                                </div>
                                <p style="font-size: 0.85rem; color: #64748b; margin: 0; line-height: 1.5;">
                                    教務主事室発行のCSV形式の名簿を読み込みます。学生の基本情報（番号・コース等）を更新します。<br>
                                    <span style="color: #ea580c; font-weight: bold;">【年度更新・進級処理】</span>
                                    新年度の名簿を読み込むと、システム全体の年度が自動的に更新されます。学籍番号（OMUID）に基づいて、氏名変更や進級データが引き継がれ、登録済みの成績データも正しく維持されます。<br>
                                    ※名簿CSVファイルには必ず「学籍番号」または「OMUID」列を含めてください。
                                </p>
                                <div id="rosterFileSummary"
                                    style="font-size: 0.8rem; padding: 0.6rem; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 0.4rem; color: #475569;">
                                    <div style="color: #94a3b8; text-align: center;">名簿未読込</div>
                                </div>

                                <!-- Historical Roster Sources -->
                                <div id="rosterHistoricalSourcesContainer" style="display: none; margin-top: 0.5rem;">
                                    <details style="font-size: 0.85rem;">
                                        <summary
                                            style="cursor: pointer; color: #64748b; font-weight: 600; padding: 0.5rem; background: #f8fafc; border-radius: 0.4rem; user-select: none;">
                                            📚 登録済みの名簿ソース
                                        </summary>
                                        <div id="rosterHistoricalSourcesList"
                                            style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </details>
                                </div>

                                <button class="btn btn-primary"
                                    onclick="document.getElementById('rosterFileInput').click()"
                                    style="margin-top: auto; justify-content: center; height: 2.8rem; font-weight: 600;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="18" height="18">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    <span>学籍名簿を読み込む</span>
                                </button>
                            </div>

                            <!-- Faculty Roster -->
                            <div
                                style="background: #fff; padding: 1.25rem; border-radius: 0.8rem; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div
                                        style="width: 32px; height: 32px; background: #f5f3ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #7c3aed;">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor" stroke-width="2" width="18" height="18">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                    <h4 style="font-size: 1rem; font-weight: 600; color: #334155; margin: 0;">
                                        教員名簿ファイル</h4>
                                </div>
                                <p style="font-size: 0.85rem; color: #64748b; margin: 0; line-height: 1.5;">
                                    指定形式(CSV)の教職員名簿を読み込みます。Teams連絡先やOMU IDの情報を管理します。</p>
                                <div id="facultyFileSummary"
                                    style="font-size: 0.8rem; padding: 0.6rem; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 0.4rem; color: #475569;">
                                    <div style="color: #94a3b8; text-align: center;">名簿未読込</div>
                                </div>

                                <!-- Historical Faculty Sources -->
                                <div id="facultyHistoricalSourcesContainer" style="display: none; margin-top: 0.5rem;">
                                    <details style="font-size: 0.85rem;">
                                        <summary
                                            style="cursor: pointer; color: #64748b; font-weight: 600; padding: 0.5rem; background: #f8fafc; border-radius: 0.4rem; user-select: none;">
                                            📚 登録済みの名簿ソース
                                        </summary>
                                        <div id="facultyHistoricalSourcesList"
                                            style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </details>
                                </div>

                                <button class="btn btn-primary"
                                    onclick="document.getElementById('facultyFileInput').click()"
                                    style="margin-top: auto; justify-content: center; background: #4f46e5; height: 2.8rem; font-weight: 600;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="18" height="18">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    <span>教職員名簿を読み込む</span>
                                </button>
                            </div>

                            <!-- Absence Info -->
                            <div
                                style="background: #fff; padding: 1.25rem; border-radius: 0.8rem; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div
                                        style="width: 32px; height: 32px; background: #f0fdf4; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #16a34a;">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor" stroke-width="2" width="18" height="18">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                    <h4 style="font-size: 1rem; font-weight: 600; color: #334155; margin: 0;">
                                        欠席情報ファイル</h4>
                                </div>
                                <p style="font-size: 0.85rem; color: #64748b; margin: 0; line-height: 1.5;">
                                    教務システムから出力された欠席情報を読み込み、出欠状況ボードに一括反映します。</p>
                                <div id="attendanceFileSummary"
                                    style="font-size: 0.8rem; padding: 0.6rem; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 0.4rem; color: #475569;">
                                    <div style="color: #94a3b8; text-align: center;">データ未読込</div>
                                </div>

                                <!-- Historical Attendance Sources -->
                                <div id="attendanceHistoricalSourcesContainer"
                                    style="display: none; margin-top: 0.5rem;">
                                    <details style="font-size: 0.85rem;">
                                        <summary
                                            style="cursor: pointer; color: #64748b; font-weight: 600; padding: 0.5rem; background: #f8fafc; border-radius: 0.4rem; user-select: none;">
                                            📚 登録済みの出欠ソース
                                        </summary>
                                        <div id="attendanceHistoricalSourcesList"
                                            style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </details>
                                </div>

                                <button class="btn btn-primary"
                                    onclick="document.getElementById('attendanceCsvFileInput').click()"
                                    style="margin-top: auto; justify-content: center; background: #10b981; height: 2.8rem; font-weight: 600;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="18" height="18">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    <span>欠席情報を読み込む</span>
                                </button>
                            </div>

                            <!-- Annual Event Calendar -->
                            <div
                                style="background: #fff; padding: 1.25rem; border-radius: 0.8rem; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div
                                        style="width: 32px; height: 32px; background: #fff7ed; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #ea580c;">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor" stroke-width="2" width="18" height="18">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                    <h4 style="font-size: 1rem; font-weight: 600; color: #334155; margin: 0;">
                                        年間行事予定表</h4>
                                </div>
                                <p style="font-size: 0.85rem; color: #64748b; margin: 0; line-height: 1.5;">
                                    学校発行の「行事予定表」(XLSX)を読み込みます。年度を自動判定し、各月の予定をカレンダーに表示します。</p>
                                <div id="annualEventFileSummary"
                                    style="font-size: 0.8rem; padding: 0.6rem; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 0.4rem; color: #475569;">
                                    <div style="color: #94a3b8; text-align: center;">データ未読込</div>
                                </div>

                                <!-- Historical Annual Event Sources -->
                                <div id="annualEventHistoricalSourcesContainer"
                                    style="display: none; margin-top: 0.5rem;">
                                    <details style="font-size: 0.85rem;">
                                        <summary
                                            style="cursor: pointer; color: #64748b; font-weight: 600; padding: 0.5rem; background: #f8fafc; border-radius: 0.4rem; user-select: none;">
                                            📅 登録済み年度の管理
                                        </summary>
                                        <div id="annualEventHistoricalSourcesList"
                                            style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </details>
                                </div>
                                <button class="btn btn-primary" onclick="loadAnnualEventsFileDialog()"
                                    style="margin-top: auto; justify-content: center; background: #f97316; height: 2.8rem; font-weight: 600;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="18" height="18">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    <span>行事予定表を読み込む</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Columns -->
                <div style="margin-top: 2rem;">
                    <!-- Right: Subject List & Storage Management -->
                    <div style="display: flex; flex-direction: column; gap: 2rem;">
                        <!-- Subject Definition Card -->
                        <div class="card">
                            <div class="card-header"
                                style="justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem; margin-bottom: 1.5rem;">
                                <div class="card-title">全学年科目定義</div>
                                <div style="display: flex; gap: 0.8rem; align-items: center;">
                                    <button id="exportSubjectsCsvBtn" class="btn btn-secondary"
                                        style="font-size: 0.85rem;">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        <span>CSV保存</span>
                                    </button>
                                    <button id="importSubjectsCsvBtn" class="btn btn-secondary"
                                        style="font-size: 0.85rem;">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                        </svg>
                                        <span>CSV読出</span>
                                    </button>
                                    <input type="file" id="subjectsCsvFileInput" accept=".csv" class="hidden">
                                    <!-- Course Filter -->
                                    <select id="subjectCourseFilter"
                                        style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; font-size: 0.85rem; margin-right: 0.5rem;">
                                        <option value="">未選択</option>
                                        <option value="エネルギー機械">エネルギー機械 (M)</option>
                                        <option value="プロダクトデザイン">プロダクトデザイン (D)</option>
                                        <option value="エレクトロニクス">エレクトロニクス (E)</option>
                                        <option value="知能情報">知能情報 (I)</option>
                                    </select>
                                    <div style="position: relative;">
                                        <input type="text" id="subjectSearchInput" placeholder="科目を検索..."
                                            style="padding: 0.5rem 1rem 0.5rem 2.2rem; border: 1px solid #cbd5e1; border-radius: 9999px; font-size: 0.85rem; width: 220px;">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            style="position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); color: #94a3b8;"
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                                            width="16" height="16">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </div>
                                    <button id="addSubjectBtn" class="btn btn-primary">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                        </svg>
                                        <span>新規科目追加</span>
                                    </button>
                                </div>
                            </div>

                            <div id="subjectsGroupedList" style="display: flex; flex-direction: column; gap: 2.5rem;">
                                <!-- Grouped by Year list will be rendered here -->
                            </div>
                        </div>

                        <!-- Storage Management Card -->
                        <div class="card" id="storage-mgmt-card">
                            <div class="card-header" style="border-bottom: 1px solid #e2e8f0; margin-bottom: 1rem;">
                                <div class="card-title">ストレージ容量管理 (Storage Management)</div>
                            </div>
                            <div class="card-body">
                                <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 1.5rem;">
                                    ブラウザの保存容量（localStorage）の使用状況を確認し、不要な一時データを削除して空き容量を増やせます。<br>
                                    <span style="color: #ef4444; font-weight: 600;">※iPadなどモバイル端末では約5MBが上限です。</span>
                                </p>

                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                                    <div
                                        style="flex: 1; height: 1.5rem; background: #e2e8f0; border-radius: 1rem; overflow: hidden; display: flex;">
                                        <div id="storage-usage-bar"
                                            style="width: 0%; background: #3b82f6; transition: width 0.5s ease;">
                                        </div>
                                    </div>
                                    <div style="font-weight: 700; color: #1e293b; font-size: 1.1rem; min-width: 100px;">
                                        <span id="storage-usage-text">0.00</span> MB / 5 MB
                                    </div>
                                </div>

                                <div class="storage-grid"
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div
                                        style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; background: #f8fafc;">
                                        <div style="font-weight: 600; color: #475569; margin-bottom: 0.25rem;">
                                            名簿ドキュメント一時データ</div>
                                        <div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.8rem;">
                                            「名簿取り込み」で読み込んだCSVの一時キャッシュです。削除しても既存の学生名簿は消えません。</div>
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 700; color: #334155;" id="storage-roster-size">0
                                                KB</span>
                                            <button id="clearRosterCacheBtn" class="btn btn-secondary"
                                                style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                    stroke="currentColor" stroke-width="2" width="16" height="16">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                                <span>キャッシュ削除</span>
                                            </button>
                                        </div>
                                    </div>

                                    <div
                                        style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; background: #f8fafc;">
                                        <div style="font-weight: 600; color: #475569; margin-bottom: 0.25rem;">
                                            出欠記録データ
                                        </div>
                                        <div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.8rem;">
                                            読み込んだすべての出欠ログデータです。削除するとカレンダーや統計が表示されなくなります。</div>
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 700; color: #334155;"
                                                id="storage-attendance-size">0
                                                KB</span>
                                            <button id="clearAttendanceDataBtn" class="btn btn-secondary"
                                                style="font-size: 0.8rem; padding: 0.4rem 0.8rem; color: #ef4444; border-color: #fecaca;">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                    stroke="currentColor" stroke-width="2" width="16" height="16">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                                <span>データ削除</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance (出欠状況) View -->
                <!-- Class Officers View -->
                <div id="class_officers-content" class="tab-content hidden fade-in">
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header" style="justify-content: space-between; align-items: center;">
                            <div class="card-title" style="display:flex; align-items:center; gap:0.6rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                クラス委員・係選出 (Class Officers)
                            </div>
                            <div style="display:flex; gap:0.5rem; align-items: center;">
                                <button onclick="showAddOfficerRoleModal()" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                    </svg>
                                    <span>新規役職追加</span>
                                </button>
                                <div class="divider-v"
                                    style="height: 20px; width: 1px; background: #e2e8f0; margin: 0 0.5rem;"></div>
                                <button onclick="resetOfficerRolesToDefault()" class="btn btn-secondary"
                                    style="color: #64748b;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    <span>デフォルト復元</span>
                                </button>
                                <button onclick="exportClassOfficersPdf()" class="btn btn-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                    </svg>
                                    <span>PDF</span>
                                </button>
                                <button onclick="exportOfficerAssignmentsCsv()" class="btn btn-secondary"
                                    title="現在の割当状況(全学年)をCSV出力します">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <span>CSV出力</span>
                                </button>
                                <button onclick="document.getElementById('officerAssignmentsCsvInput').click();"
                                    class="btn btn-secondary" title="CSVから割当状況を読み込みます">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    <span>CSV読込</span>
                                </button>
                                <input type="file" id="officerAssignmentsCsvInput" class="hidden"
                                    accept=".csv,text/csv,text/plain" onchange="importOfficerAssignmentsCsv(event)">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
                        <!-- Left Sidebar: Student List for dragging -->
                        <div class="card"
                            style="width: 280px; flex-shrink: 0; position: sticky; top: 1rem; max-height: calc(100vh - 12rem); display: flex; flex-direction: column;">
                            <div class="card-header" style="padding: 0.8rem 1rem;">
                                <h3 class="card-title"
                                    style="font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                    学生リスト (Drag)
                                </h3>
                            </div>
                            <div id="officerStudentList"
                                style="padding: 0.5rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.3rem;">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Right Main: Role Categories -->
                        <div style="flex-grow: 1;">
                            <div id="officerCategoriesGrid"
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                                <!-- Populated by JS -->
                            </div>


                        </div>
                    </div>
                </div>

                <div id="attendance-content" class="tab-content hidden fade-in">
                    <div class="card">
                        <div class="card-header" style="justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                            <div class="card-title">出欠カレンダー (Attendance Calendar)</div>
                            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;"
                                class="no-print">
                                <div class="control-group">
                                    <label for="attendanceMonthSelect">年月:</label>
                                    <select id="attendanceMonthSelect" style="width: 140px;">
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                                <div class="control-group">
                                    <label style="display: flex; align-items: center; gap: 0.4rem; cursor: pointer;">
                                        <input type="checkbox" id="attFilterBadOnly"
                                            onchange="toggleAttendanceBadOnlyMode()" style="width: 16px; height: 16px;">
                                        <span style="font-size: 0.85rem; color: #475569;">欠席・遅刻のみ</span>
                                    </label>
                                </div>
                                <div class="divider-v"></div>
                                <input type="file" id="attendanceCsvFileInput" accept=".csv,text/csv,text/plain"
                                    class="hidden">
                            </div>
                        </div>

                        <div id="attendanceInfoBar"
                            style="background: #f1f5f9; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; font-size: 0.85rem; color: #475569; border: 1px solid #e2e8f0;">
                            <div id="attendancePeriodInfo">期間：未設定</div>
                            <div id="attendanceFileInfo">ファイル：未読込</div>
                        </div>


                        <div id="attendanceCalendarGrid"
                            style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden;">
                            <!-- Grid cells populated by JS -->
                        </div>

                        <div class="card" style="margin-top: 1.5rem; padding: 1.2rem;">
                            <div class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">累積出欠推移 (Cumulative
                                Attendance Trend)</div>
                            <div style="height: 300px; position: relative;">
                                <canvas id="cumulativeAttendanceChart"></canvas>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1.5rem; padding: 1.2rem;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div class="card-title" style="font-size: 1rem; margin-bottom: 0;">科目別出欠推移 (Subject
                                    Attendance Trend)</div>
                                <div class="control-group">
                                    <label for="attendanceSubjectFilter">科目:</label>
                                    <select id="attendanceSubjectFilter" style="width: 200px;">
                                        <option value="">-- 科目を選択 --</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                            </div>
                            <div style="height: 300px; position: relative;">
                                <canvas id="subjectAttendanceChart"></canvas>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1.5rem; padding: 1.2rem;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div class="card-title" style="font-size: 1rem; margin-bottom: 0;">曜日別出欠推移 (Day of Week
                                    Attendance Trend)</div>
                                <div class="control-group">
                                    <label for="attendanceDayFilter">曜日:</label>
                                    <select id="attendanceDayFilter" style="width: 140px;">
                                        <option value="1">月曜日</option>
                                        <option value="2">火曜日</option>
                                        <option value="3">水曜日</option>
                                        <option value="4">木曜日</option>
                                        <option value="5">金曜日</option>
                                        <option value="6">土曜日</option>
                                        <option value="0">日曜日</option>
                                    </select>
                                </div>
                            </div>
                            <div style="height: 300px; position: relative;">
                                <canvas id="dayAttendanceChart"></canvas>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1.5rem; padding: 1.2rem;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div class="card-title" style="font-size: 1rem; margin-bottom: 0;">時限別出欠推移 (Period
                                    Attendance Trend)</div>
                                <div class="control-group">
                                    <label for="attendancePeriodFilter">時限:</label>
                                    <select id="attendancePeriodFilter" style="width: 120px;">
                                        <option value="1">1限</option>
                                        <option value="2">2限</option>
                                        <option value="3">3限</option>
                                        <option value="4">4限</option>
                                        <option value="5">5限</option>
                                        <option value="6">6限</option>
                                        <option value="7">7限</option>
                                        <option value="8">8限</option>
                                    </select>
                                </div>
                            </div>
                            <div style="height: 300px; position: relative;">
                                <canvas id="periodAttendanceChart"></canvas>
                            </div>
                        </div>

                    </div>

                    <div id="attendanceDailyStats" class="card" style="margin-top: 2rem; padding: 1rem;">
                        <div class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">月間統計 (Monthly Statistics)
                        </div>
                        <div class="table-container">
                            <table id="attendanceStatsTable">
                                <thead>
                                    <tr style="background: #f1f5f9;">
                                        <th rowspan="2" style="width: 180px; vertical-align: middle;">授業科目</th>
                                        <th rowspan="2" style="width: 110px; vertical-align: middle;">担当者</th>
                                        <th colspan="4"
                                            style="text-align: center; border-bottom: 2px solid #e2e8f0; background: #f0f9ff; color: #1e40af;">
                                            月間統計 (Monthly)</th>
                                        <th colspan="4"
                                            style="text-align: center; border-bottom: 2px solid #e2e8f0; border-left: 2px solid #e2e8f0; background: #fdfaf0; color: #92400e;">
                                            全期間統計 (Cumulative)</th>
                                    </tr>
                                    <tr style="background: #f8fafc; font-size: 0.75rem;">
                                        <th style="text-align: center; border-left: 1px solid #e2e8f0;">欠</th>
                                        <th style="text-align: center;">遅</th>
                                        <th style="text-align: center;">早</th>
                                        <th style="text-align: center; font-weight: bold; background: #e0f2fe;">計</th>
                                        <th style="text-align: center; border-left: 2px solid #e2e8f0;">欠</th>
                                        <th style="text-align: center;">遅</th>
                                        <th style="text-align: center;">早</th>
                                        <th style="text-align: center; font-weight: bold; background: #fef3c7;">計</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceStatsBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Help & Security View -->
                <div id="help-content" class="tab-content hidden fade-in">
                    <!-- GENE Version Feature Summary -->
                    <div class="card"
                        style="background: linear-gradient(135deg, #1e293b, #334155); color: white; border: none; margin-bottom: 2rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <h2 class="card-title" style="color: white; display:flex; align-items:center; gap:0.8rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                Grade Manager GENE 機能概要
                            </h2>
                        </div>
                        <div style="padding: 1.5rem;">
                            <ul
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 1rem; list-style: none; padding: 0; margin: 0;">
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>システムへのパスワードログイン</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">セキュアなハッシュ認証によるデータ保護</span></div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>学生個人：教務システムからのコピペ成績入力</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">成績個票からの簡単インポート機能（成績個票入力）</span>
                                    </div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>学生個人：卒業要件確認①</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">単位数・必修・DP-X科目の取得確認</span></div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>学生個人：卒業要件確認②</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">DP-X科目の開講スケジュールと進捗確認</span>
                                    </div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>学生個人：全定期試験の平均点・順位推移</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">登録済みすべての試験結果の推移を可視化</span></div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>学生個人：評点・GPAの累積推移</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">学年ごとの単純平均・加重平均・GPA算出</span>
                                    </div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>クラス統計：平均点・累積GPAのまとめ</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">最新テスト結果に基づいたクラス全体の状況把握</span>
                                    </div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>要注意学生のピックアップ</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">最新テストと年度通算の二通りでリスク学生を抽出</span>
                                    </div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>各種設定 (Settings)</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">科目定義・学生名簿・パスワード等の管理</span></div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>席決め：成績分布の可視化配置</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">教室内の成績分布を確認しながら席配置可能</span>
                                    </div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>名簿管理・取り込み (Roster)</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">CSVによる学生名簿の一括管理・プレビュー読み込み</span>
                                    </div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>教職員名簿 (Faculty)</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">教職員情報の管理とTeams/メール連携</span>
                                    </div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>出欠状況 (Attendance)</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">月次・科目別の出欠記録と統計分析</span></div>
                                </li>
                                <li
                                    style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 0.8rem;">
                                    <div style="color: #60a5fa; font-weight: bold;">✓</div>
                                    <div><strong>クラス委員・係 (Officers)</strong><br><span
                                            style="font-size: 0.85rem; color: #94a3b8;">クラス役員・係の設定と割当管理。CSV同期、Teamsグループチャット連携、PDF出力に対応</span>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="card" style="background: #f8fafc; border-left: 5px solid var(--primary);">
                        <div class="card-header">
                            <h2 class="card-title">基本的な使用方法 (Basic Usage)</h2>
                        </div>
                        <div style="line-height: 1.8; color: #334155;">
                            <ol style="margin-left: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
                                <li><strong>1. 初期設定とマスタ管理:</strong><br>
                                    「各種設定
                                    (Settings)」タブで、学生名簿と各学年の科目定義（単位数・種別・DP等）を登録します。名簿ファイル（csv/txt）のドラッグ＆ドロップ読込にも対応しています。
                                </li>
                                <li><strong>2. 成績データの入力:</strong><br>
                                    「成績一覧 (Grades)」タブで、対象学年と学生を選択します。各テスト点数を直接入力するか、表上部の<span class="paste-icon"
                                        style="opacity:1; vertical-align:middle; margin:0 2px;"><svg
                                            xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path
                                                d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                            </path>
                                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                        </svg></span>アイコンからExcel等のデータを一括貼り付けできます。
                                </li>
                                <li><strong>3. 個別・累計分析:</strong><br>
                                    「分析1 (Stats)」で単一テストの分布図と順位推移、「分析2 (Stats2)」で複数年にわたるGPAと加重平均の累積推移を確認できます。
                                </li>
                                <li><strong>4. 卒業要件の確認:</strong><br>
                                    「卒業要件 (Grad
                                    Requirements)」では、現在の取得単位がDP（A~E）やSDGs、一般/専門科目、必修科目の基準をどの程度満たしているか自動集計します（コース選択が必要です）。
                                </li>
                                <li><strong>5. クラス帳票と要注意抽出:</strong><br>
                                    「クラス状況のまとめ (Class Stats)」で全員の成績一覧・GPA一覧を作成できます。「要注意抽出
                                    (At-Risk)」機能により、成績不振科目が複数ある学生を瞬時に特定します。
                                </li>
                                <li><strong>6. 名簿・出欠・役員管理:</strong><br>
                                    「名簿管理 (Roster)」で学生情報を更新、「教職員名簿 (Faculty)」で連絡先管理、「出欠状況 (Attendance)」で欠課集計・管理、「クラス委員
                                    (Officers)」で役職決め・記録をサポートします。
                                </li>
                                <li><strong>7. 出欠メモとガントチャート:</strong><br>
                                    「クラス出欠状況 (Class Attendance
                                    Gantt)」でクラス全体の長期的な出欠を一目で確認できます。セルをクリックまたは右クリックで欠席理由などのメモ（★）を記録・編集できます。
                                </li>
                                <li><strong>8. 年間行事予定の確認と蓄積:</strong><br>
                                    「年間行事予定表 (Annual
                                    Events)」タブでは、学校発行の行事予定Excelを取り込み、年度・月ごとにカレンダー表示します。年度をまたいでデータを蓄積できるため、登録済みの試験日程等の参照が可能です。
                                </li>
                            </ol>
                        </div>
                    </div>



                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">使用上のご注意 (Security & Privacy)</h2>
                        </div>
                        <div style="line-height: 1.8; color: #334155;">
                            <p>本システムはオフライン第一の設計となっており、学生の機密情報を保持したまま安全に利用可能です。</p>
                            <ul
                                style="margin-left: 1.5rem; margin-top: 1rem; margin-bottom: 1.5rem; list-style-type: disc;">
                                <li><strong>サーバー送信なし:</strong>
                                    データがインターネット上のサーバーに送信されることは<strong>一切ありません</strong>。すべての集計はブラウザ内で完結します。</li>
                                <li><strong>ローカル保存:</strong> データはブラウザの <strong>LocalStorage</strong>
                                    に暗号化またはシリアル化されて保存されます。他のPCやブラウザとは同期されません。</li>
                                <li><strong>パスワード保護:</strong> 起動時にSHA-256ハッシュによるパスワード認証が必要です。設定で変更や保護の解除も可能です。</li>

                                <li
                                    style="border-top: 1px dashed #e2e8f0; margin: 1rem 0; padding-top: 1rem; list-style: none;">
                                    <strong>【重要】年度更新と学生管理について</strong><br>
                                    <div style="font-size: 0.9rem; color: #475569; margin-top: 0.5rem;">
                                        進級・留年・退学等に伴うデータの取り扱いは以下の通りです：
                                        <ul
                                            style="margin-left: 1.2rem; margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.4rem; list-style-type: circle;">
                                            <li><strong>学生の識別:</strong> 学籍番号（OMU ID）をキーに、年度を跨いでも同一人物として成績が累積されます。</li>
                                            <li><strong>除籍・退学:</strong> 新名簿から消えた学生は選択肢に出ませんが、過去の成績データ自体はシステム内に保持されます。
                                            </li>
                                            <li><strong>原級留置（留年）:</strong>
                                                同じ学年に留まっても、過去の成績の上に新しいデータが積み重なり、GPAも通算で計算されます。</li>
                                            <li><strong>年度末保存:</strong>
                                                JSONエクスポートは「全履歴・全成績」を含む完全なスナップショットです。年度の区切りには必ず保存してください。</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="color: #b91c1c; font-weight: bold;">使用上の注意:
                                    共用PCでは必ず「Logout」して終了してください（パスワード入力画面に戻ります）。</li>
                                <li style="color: #b91c1c; font-weight: bold;">データバックアップ:
                                    重要なデータは定期的に「JSON/Score」でエクスポートしてバックアップを取ることを強く推奨します。このJSONファイルには、登録済みの全年度の名簿・教員・出欠・行事の履歴、および全学生の累計成績、全設定が含まれます。ブラウザのデータ削除やキャッシュクリアでデータが失われる可能性があります。
                                </li>
                                <li style="color: #b91c1c; font-weight: bold;">機密情報の取り扱い:
                                    生成ファイルやキャッシュに機密３情報を含む可能性がありますので、学校の管理下にある端末でご使用ください。
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">入出力ファイルと用途</h2>
                        </div>
                        <div class="table-container">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f1f5f9;">
                                        <th style="padding: 10px; border: 1px solid #cbd5e1;">形式</th>
                                        <th style="padding: 10px; border: 1px solid #cbd5e1;">用途</th>
                                        <th style="padding: 10px; border: 1px solid #cbd5e1;">内容</th>
                                        <th style="padding: 10px; border: 1px solid #cbd5e1;">操作場所</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">PDF
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">配布・印刷用（出力のみ）</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            個人成績レポート、推移グラフ、クラス順位表、要注意者抽出結果など
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">ヘッダー「PDF」ボタン</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">JSON
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">バックアップ・復元</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            <strong>出力:</strong>
                                            全年度の成績、科目マスタ、出欠履歴、登録済みソースの履歴（名簿等の全メタデータ）、座席配置、時間割、クラス委員設定等、システム上の全情報の完全なスナップショット<br>
                                            <strong>読込:</strong> エクスポートしたJSONファイルから、過去の履歴を含めた全システム状態を完全に復元
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            ヘッダー「JSON/Score」「JSON/Load」ボタン
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">
                                            CSV<br>(学生)
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">学生リスト管理</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            <strong>出力:</strong> 学生名とメタデータ（学年、組、出席番号など）を含むリスト<br>
                                            <strong>読込:</strong> 学生名とメタデータの一括登録・更新
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">設定タブ「学生リスト」セクション</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">
                                            CSV<br>(科目)
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">科目定義管理</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            <strong>出力:</strong> 全学年の科目定義（科目名、単位数、学年、種別など）<br>
                                            <strong>読込:</strong> 科目定義の一括登録・更新
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">設定タブ「全学年科目定義」セクション</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">
                                            CSV<br>(名簿)
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">学生名簿取り込み</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            <strong>読込:</strong> 学籍番号、氏名、学年、組、性別、コースなどの詳細情報を含む名簿データ（プレビュー機能付き）
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">「名簿管理・取り込み」タブ</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">
                                            CSV<br>(教職員)</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">教職員名簿管理</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            <strong>読込:</strong> 教職員の氏名、メールアドレス、部署、役職などの情報（Teams連携・メール送信機能対応）
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">「教職員名簿」タブ</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">
                                            CSV<br>(役員)</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">クラス委員割当同期</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            <strong>読込:</strong> 学年、カテゴリ、役割、氏名の割当リスト。未定義ロールの自動追加および空定義の削除を同期
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">「クラス委員」タブ</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">
                                            JSON<br>(座席)</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">座席配置保存</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            座席レイアウト（行列数、無効席）と学生配置情報のプリセット保存・読込（複数保存可能）
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">「席決め」タブ</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">
                                            XLSX<br>(年間行事)</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">年間行事予定の管理</td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            <strong>読込:</strong>
                                            学校等で公式発行される年間行事予定表のExcelファイル（「本科」シート）。年度を自動検出し、年度ごとの積層管理（追加・置換）に対応します。
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">「年間行事予定表」タブ</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">出欠管理機能 (Attendance)</h2>
                        </div>
                        <div style="line-height: 1.8; color: #334155;">
                            <ul style="margin-left: 1.5rem; list-style-type: disc;">
                                <li><strong>個人出欠カレンダー:</strong> カレンダー上で欠席・遅刻・早退・忌引等の記録を確認・編集できます。メモ機能で理由なども記録可能です。</li>
                                <li><strong>クラス出欠ガントチャート:</strong>
                                    長期的な視点でクラス全体の出欠状況を一覧表示します。
                                    <ul>
                                        <li>ドラッグ操作で複数日の範囲選択が可能</li>
                                        <li>右クリックで「期間予定（長期欠席など）」の一括登録</li>
                                        <li>セルをクリックまたは右クリックで「メモ（★）」の編集が可能</li>
                                        <li>A4用紙に最適化された印刷レイアウト対応</li>
                                    </ul>
                                </li>
                                <li><strong>教務システム連携:</strong> 教務システムから出力される「出欠ログCSV」を取り込むことで、最新の出欠データを一括反映できます。</li>
                                <li><strong>出欠統計解析:</strong> クラス全員の累積欠席・遅刻・早退数を一覧表示。項目別のソートにより、指導対象学生の早期発見をサポートします。</li>
                                <li><strong>要注意学生の抽出:</strong> 成績不振や出欠過多の学生を判定基準に基づき自動抽出。Teams連携により即時のフォローアップが可能です。</li>
                            </ul>
                        </div>
                    </div>


                    <div class="card" style="border-left: 5px solid #f59e0b;">
                        <div class="card-header">
                            <h2 class="card-title" style="color: #92400e;">重要・免責事項</h2>
                        </div>
                        <div style="line-height: 1.8; color: #334155;">
                            <p style="font-weight: bold;">本システムで算出されるデータは、学習指導の参考とするための「参考値」です。</p>
                            <p style="margin-top: 1rem;">
                                平均点、順位、GPA、累計単位数等の計算結果には、システム上の端数処理や各種推定値が含まれる場合があります。単位修得の可否や進級判定等の最終的かつ公式な判断は、必ず<strong>教務発行の正式な書類（通知表、成績証明書等）</strong>を正として判断してください。
                            </p>
                            <p style="margin-top: 0.5rem; color: #b91c1c; font-size: 0.9rem;">
                                ※ 特別学修単位の算入には上限がありますが、本システムでは上限は考慮されませんのでご注意ください。
                            </p>
                        </div>
                    </div>
                </div>
        </section>
    </main>

    <!-- Subject Edit Modal -->
    <div id="subjectModal" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title" id="subjectModalTitle">科目の編集</div>
                <button class="close-btn" onclick="closeSubjectModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="subjectForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <input type="hidden" id="editSubjectOldName">

                    <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                        <label>授業科目名 (Subject Name)</label>
                        <input type="text" id="subjectNameInput" style="width: 100%; border-width: 2px;"
                            placeholder="例: 数学Ⅰ" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                            <label>単位数 (Credits)</label>
                            <input type="number" id="subjectCreditsInput" style="width: 100%;" min="0" required>
                        </div>
                        <div id="subjectYearWrapper" class="control-group"
                            style="flex-direction: column; align-items: flex-start;">
                            <label>学年 (Target Year)</label>
                            <input type="number" id="subjectYearInput" style="width: 100%;" min="1" max="5" required>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div id="subjectType1Wrapper" class="control-group"
                            style="flex-direction: column; align-items: flex-start;">
                            <label>種別1 (区分)</label>
                            <select id="subjectType1Input" style="width: 100%;">
                                <option value="必履修">必履修 (要履修)</option>
                                <option value="必修得">必修得 (要単位)</option>
                                <option value="選">選 (選択)</option>
                                <option value="選必">選必 (選択必修)</option>
                                <option value="特別学修">特別学修</option>
                            </select>
                        </div>
                        <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                            <label>種別2 (一般/専門)</label>
                            <select id="subjectType2Input" style="width: 100%;">
                                <option value="一般">一般</option>
                                <option value="専門共通">専門共通</option>
                                <option value="基盤専門">基盤専門</option>
                                <option value="応用専門">応用専門</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                        <label>種別3 (詳細・管理タグ)</label>
                        <input type="text" id="subjectType3Input" list="type3Suggestions" style="width: 100%;"
                            placeholder="例: DP-A, SDGs, etc.">
                        <datalist id="type3Suggestions">
                            <option value="DP-A">
                            <option value="DP-B">
                            <option value="DP-C">
                            <option value="DP-D">
                            <option value="DP-E">
                            <option value="SDGs">
                            <option value="Other">
                        </datalist>
                    </div>
                    <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                        <label>種別4 (コース)</label>
                        <input type="text" id="subjectType4Input" list="type4Suggestions" style="width: 100%;"
                            placeholder="例: コース共通, Mコース, etc.">
                        <datalist id="type4Suggestions">
                            <option value="コース共通">
                            <option value="エネルギー機械">
                            <option value="プロダクトデザイン">
                            <option value="エレクトロニクス">
                            <option value="知能情報">
                        </datalist>
                    </div>
                    <!-- Stats Exclude Toggle -->
                    <div class="control-group"
                        style="margin-top: 1.5rem; flex-direction: row; align-items: center; gap: 0.8rem; background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        <input type="checkbox" id="excludeFromGpa"
                            style="width: 1.2rem; height: 1.2rem; cursor: pointer;">
                        <label for="excludeFromGpa"
                            style="cursor: pointer; font-weight: 500; color: #475569; margin: 0;">評定平均に考慮しない (Exclude
                            from GPA)</label>
                    </div>
                    <!-- Special Study Toggle -->
                    <div class="control-group"
                        style="margin-top: 0.5rem; flex-direction: row; align-items: center; gap: 1rem; background: #fffbeb; padding: 1.25rem; border-radius: 0.75rem; border: 2px solid #fde68a;">
                        <input type="checkbox" id="isSpecialSubject"
                            style="width: 1.5rem; height: 1.5rem; cursor: pointer;">
                        <label for="isSpecialSubject"
                            style="cursor: pointer; font-weight: 600; color: #92400e; margin: 0; font-size: 1.1rem;">特別学修科目として登録<br><span
                                style="font-size: 0.85rem; font-weight: 400; color: #b45309;">(名前の先頭に「特・」を付与します)</span></label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSubjectModal()">キャンセル</button>
                <button class="btn btn-primary" id="saveSubjectItemBtn">適用</button>
            </div>
        </div>
    </div>



    <!-- Paste Modal -->
    <div id="pasteModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">成績貼り付け (Paste Scores)</div>
                <button class="close-btn" id="closeModalBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9em;">
                    Excel、教務システム、その他の表計算ソフトからコピーした成績データを貼り付けてください。<br>
                    学年、授業科目名を含む行もそのまま貼り付けて構いません。
                </p>
                <textarea id="pasteArea" class="paste-area" placeholder="授業科目\t単位\t点数..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelPasteBtn">Cancel</button>
                <button class="btn btn-primary" id="applyPasteBtn">反映 (Apply)</button>
            </div>
        </div>
    </div>

    <!-- Import Preview Modal -->
    <div id="importPreviewModal" class="modal-overlay">
        <div class="modal" style="max-width: 900px; height: 85vh;">
            <div class="modal-header">
                <div class="modal-title">名簿取り込みプレビュー (Import Preview)</div>
                <button class="close-btn" onclick="closeImportPreviewModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 1rem; overflow: hidden;">
                <div style="background: #eff6ff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #bfdbfe;">
                    <p style="margin: 0; color: #1e40af; font-size: 0.9rem; font-weight: 600;">取り込む学生を選択してください</p>
                    <p style="margin: 0.2rem 0 0 0; color: #3b82f6; font-size: 0.85rem;">
                        CSVから解析された以下の学生リストを確認・絞り込みし、成績管理の対象として登録します。<br>
                        ※既に登録済みの学生名は維持されますが、情報は上書きされる可能性があります。
                    </p>
                </div>

                <!-- Filters -->
                <div id="importFilters"
                    style="display: flex; gap: 1rem; flex-wrap: wrap; padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0; align-items: center;">
                    <!-- Dynamically populated -->
                    <!-- Hardcoded Sort Control will be appended or handled by JS -->
                    <div class="control-group">
                        <label for="importSortBy">並び替え:</label>
                        <select id="importSortBy"
                            style="padding: 0.4rem 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; font-size: 0.85rem; background: #fff;">
                            <option value="original">ファイル順</option>
                            <option value="studentId">学籍番号順</option>
                            <option value="name">氏名順</option>
                            <option value="year">学年順</option>
                            <option value="class">組順</option>
                        </select>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-container"
                    style="flex: 1; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead
                            style="position: sticky; top: 0; background: #f8fafc; z-index: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                            <tr>
                                <th style="width: 40px; text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" id="importSelectAll" checked style="cursor: pointer;">
                                </th>
                                <th style="text-align: left;">氏名</th>
                                <th style="text-align: left;">No.</th>
                                <th style="text-align: left;">学年</th>
                                <th style="text-align: left;">組</th>
                                <th style="text-align: left;">性別</th>
                                <th style="text-align: left;">コース/選択</th>
                            </tr>
                        </thead>
                        <tbody id="importPreviewBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div style="text-align: right; font-size: 0.85rem; color: #64748b;" id="importCountInfo">
                    0 名中 0 名選択中
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportPreviewModal()">キャンセル</button>
                <button class="btn btn-primary" id="confirmImportBtn">選択した学生を取り込み (Import)</button>
            </div>
        </div>
    </div>

    <!-- Metadata Editor Modal -->
    <div id="metadataEditorModal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">学生情報編集 (Edit Student Metadata)</div>
                <button class="close-btn" onclick="closeMetadataEditorModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 0.5rem;">氏名
                        (Name)</label>
                    <input type="text" id="metaEditName" readonly
                        style="width: 100%; padding: 0.5rem; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 0.3rem; color: #64748b;">
                    <input type="hidden" id="metaEditOriginalName">
                </div>
                <div id="metaEditFieldsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- Dynamic fields will be injected here -->
                </div>
                <div style="margin-top: 1rem; text-align: right;">
                    <button class="btn btn-secondary" onclick="addCustomMetadataField()" style="font-size: 0.8rem;">+
                        フィールド追加 (Add Field)</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMetadataEditorModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveStudentMetadata()">保存 (Save)</button>
            </div>
        </div>
    </div>

    <!-- Add Officer Role Modal -->
    <div id="addOfficerRoleModal" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="officerRoleModalTitle">新規役職・係の定義</h2>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editOfficerCatIdx" value="-1">
                <input type="hidden" id="editOfficerRoleIdx" value="-1">
                <div style="margin-bottom: 1rem;">
                    <label
                        style="display:block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.4rem;">カテゴリー</label>
                    <select id="newRoleCategory" class="input-field">
                        <option value="クラス役員 (HR Officers)">クラス役員</option>
                        <option value="係・分掌 (Class Duties)">係・分掌</option>
                        <option value="行事委員 (Event Committees)">行事委員</option>
                        <option value="学友会関連 (Student Association)">学友会関連</option>
                        <option value="その他 (Others)">その他</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label
                        style="display:block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.4rem;">役職・係名</label>
                    <input type="text" id="newRoleName" class="input-field" placeholder="例: 広報係">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display:block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.4rem;">メンバー数上限
                        (0で制限なし)</label>
                    <input type="number" id="newRoleLimit" class="input-field" value="1" min="0">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label
                        style="display:block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.4rem;">職務説明</label>
                    <textarea id="newRoleDesc" class="input-field"
                        style="width: 100%; height: 120px; font-family: inherit; font-size: 1rem; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.3rem;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('addOfficerRoleModal').classList.remove('open')">キャンセル</button>
                <button class="btn btn-primary" id="saveOfficerRoleBtn" onclick="saveNewOfficerRole()">追加定義する</button>
            </div>
        </div>
    </div>



    <!-- Attendance Period Event Modal -->
    <div id="attendanceEventModal" class="modal-overlay">
        <div class="modal" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <div class="modal-title" id="attEventModalTitle">イベント編集</div>
                <button class="close-btn"
                    onclick="document.getElementById('attendanceEventModal').classList.remove('open')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                <!-- Student Identity Display -->
                <div id="attEventStudentNameDisplay"
                    style="margin-bottom: 1rem; padding: 0.6rem 1rem; background: #f1f5f9; border-radius: 0.5rem; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 0.6rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2" width="18" height="18" style="color: #64748b;">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span style="font-size: 0.85rem; color: #64748b; font-weight: 500;">対象学生:</span>
                    <span id="attEventStudentNameValue"
                        style="font-weight: 700; color: #1e293b; font-size: 1rem;">-</span>
                </div>

                <input type="hidden" id="attEventId">
                <input type="hidden" id="attEventStart">
                <input type="hidden" id="attEventEnd">

                <div
                    style="display: grid; grid-template-columns: 1fr 1fr 100px; gap: 1rem; margin-bottom: 1.5rem; background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                    <div>
                        <label
                            style="display: block; font-size: 0.75rem; font-weight: bold; color: #64748b; margin-bottom: 0.4rem;">開始日</label>
                        <input type="date" id="attEventStartDate" class="input-field" style="padding: 0.4rem;"
                            onchange="updateAttEventModalDates()">
                    </div>
                    <div>
                        <label
                            style="display: block; font-size: 0.75rem; font-weight: bold; color: #64748b; margin-bottom: 0.4rem;">終了日</label>
                        <input type="date" id="attEventEndDate" class="input-field" style="padding: 0.4rem;"
                            onchange="updateAttEventModalDates()">
                    </div>
                    <div style="text-align: center;">
                        <label
                            style="display: block; font-size: 0.75rem; font-weight: bold; color: #64748b; margin-bottom: 0.4rem;">合計日数</label>
                        <div id="attEventDaysCount"
                            style="font-weight: bold; color: var(--primary); font-size: 1.2rem; line-height: 2.2rem;">-
                            日</div>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.4rem;">カテゴリー</label>
                    <div style="display: flex; align-items: center; gap: 0.8rem;">
                        <select id="attEventCategory" class="input-field" style="flex: 1;"
                            onchange="updateAttEventColorHint()">
                            <option value="体調不良" data-color="#fb7185">🌸 体調不良</option>
                            <option value="感染症出席停止" data-color="#ef4444">🔴 感染症出席停止</option>
                            <option value="就職活動" data-color="#3b82f6">🔵 就職活動</option>
                            <option value="インターンシップ" data-color="#10b981">🟢 インターンシップ</option>
                            <option value="部活動遠征" data-color="#f59e0b">🟠 部活動遠征</option>
                            <option value="不明（要確認）" data-color="#64748b">⚪ 不明（要確認）</option>
                            <option value="その他" data-color="#8b5cf6">🟣 その他（定義）</option>
                        </select>
                        <div id="attEventColorPreview"
                            style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 1px #e2e8f0; background: #fb7185; flex-shrink: 0; transition: background 0.2s;">
                        </div>
                    </div>
                </div>
                <div id="attEventCustomLabelArea" style="margin-bottom: 1.5rem; display: none;">
                    <label
                        style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.4rem;">表示ラベル</label>
                    <input type="text" id="attEventCustomLabel" class="input-field" placeholder="例: 忌引">
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.4rem;">全体メモ
                        (Period Note)</label>
                    <textarea id="attEventNote" class="input-field" style="width: 100%; height: 80px; padding: 0.5rem;"
                        placeholder="期間全体に関わる内容"></textarea>
                </div>

                <div style="border-top: 1px dashed #cbd5e1; padding-top: 1.5rem;">
                    <label
                        style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.8rem; font-weight: bold;">各日の詳細メモ
                        (Daily Notes)</label>
                    <div id="attEventDailyNotesContainer" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- JSで動的に追加 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <div>
                    <button id="attEventDeleteBtn" class="btn"
                        style="color: #ef4444; background: #fef2f2; border: 1px solid #fecaca; display: flex; align-items: center; gap: 0.4rem;"
                        onclick="deleteAttendancePeriodEvent()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            stroke-width="2" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        このイベントを削除
                    </button>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary"
                        onclick="document.getElementById('attendanceEventModal').classList.remove('open')">キャンセル</button>
                    <button class="btn btn-primary" onclick="saveAttendancePeriodEvent()">保存する</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timetable Context Menu -->
    <div id="timetableContextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item" id="ctxCut">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16"
                height="16">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M14.121 14.121L19 19m0-4.879L14.121 14.121m0 0A3 3 0 1012 11a3 3 0 002.121 3.121zM7.121 7.121L2 2m0 4.879L7.121 7.121m0 0A3 3 0 105 4a3 3 0 002.121 3.121z" />
            </svg>
            切り取り
        </div>
        <div class="context-menu-item" id="ctxCopy">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16"
                height="16">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
            </svg>
            コピー
        </div>
        <div class="context-menu-item" id="ctxPaste">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16"
                height="16">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            貼り付け
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="ctxDelete" style="color: #ef4444;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16"
                height="16">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            削除
        </div>
    </div>

    <style>
        .context-menu {
            position: fixed;
            z-index: 10000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            min-width: 160px;
            padding: 6px;
            animation: ctxPop 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            transform-origin: top left;
        }

        @keyframes ctxPop {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .context-menu-item {
            padding: 10px 12px;
            font-size: 0.9rem;
            color: #1e293b;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .context-menu-item:hover {
            background: #f1f5f9;
            color: #4f46e5;
        }

        .context-menu-item svg {
            color: #64748b;
            transition: color 0.15s;
        }

        .context-menu-item:hover svg {
            color: #4f46e5;
        }

        .context-menu-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 4px 6px;
        }

        /* Prevent text selection on mobile while long-pressing */
        .timetable-cell {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
    </style>

    <div id="print-overlay" class="print-overlay"></div>
    <script src="context_menu_helper.js"></script>
    <script src="settings_ui_helper.js"></script>
    <script src="timetable_editor.js"></script>
    <script src="class_stats.js"></script>
    <script src="script.js?v=4"></script>
</body>

</html>