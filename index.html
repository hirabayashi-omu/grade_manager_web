<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Manager | クラス統合管理</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@4.2.4/build/index.umd.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <div class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            Grade Manager
            <button id="headerHelpBtn"
                style="background:none; border:none; color:#94a3b8; cursor:pointer; padding:4px; display:inline-flex; align-items:center; border-radius:50%; transition:all 0.2s;"
                title="使用方法・セキュリティポリシーを表示">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2" width="20" height="20">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                </svg>
            </button>
        </div>

        <div class="controls">
            <div class="control-group" title="表示する対象コースを選択してください">
                <label for="subjectCourseFilterHeader">コース</label>
                <select id="subjectCourseFilterHeader">
                    <option value="">未選択</option>
                    <option value="エネルギー機械">エネルギー機械 (M)</option>
                    <option value="プロダクトデザイン">プロダクトデザイン (D)</option>
                    <option value="エレクトロニクス">エレクトロニクス (E)</option>
                    <option value="知能情報">知能情報 (I)</option>
                </select>
            </div>

            <div class="control-group" title="成績データが入力されていない科目を非表示にします">
                <input type="checkbox" id="hideEmptySubjects" checked>
                <label for="hideEmptySubjects">単位認定のない科目を隠す</label>
            </div>

            <div class="control-group">
                <label for="yearSelect">学年</label>
                <select id="yearSelect" title="表示する学年を選択してください">
                    <option value="1">1年</option>
                    <option value="2">2年</option>
                    <option value="3">3年</option>
                    <option value="4">4年</option>
                    <option value="5">5年</option>
                </select>
            </div>

            <div class="control-group">
                <label for="studentSelect">学生</label>
                <select id="studentSelect" style="width: 150px;" title="成績を表示する学生を選択してください">
                    <!-- Populated by JS -->
                </select>
            </div>

            <button id="saveBtn" class="btn btn-primary" title="現在の成績データをブラウザに保存します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                </svg>
                Save
            </button>

            <button id="printBtn" class="btn btn-secondary" title="統計・グラフをPDFとして出力します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                PDF
            </button>
            <button id="exportJsonBtn" class="btn btn-secondary" title="成績データをJSON形式でダウンロードします">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                JSON
            </button>
            <input type="file" id="csvFileInput" accept=".csv,.json" style="display: none;">
            <button id="importBtn" class="btn btn-secondary" title="CSVまたはJSONファイルから学生リストまたは成績データを読み込みます">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Load
            </button>
            <!-- Clear button removed from here, moved to Settings -->
            <button id="logoutBtn" class="btn btn-secondary" title="システムをロックしてログアウトします" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Logout
            </button>
        </div>
    </header>

    <!-- Authentication Overlays -->
    <div id="authOverlay" class="modal-overlay" style="z-index: 10000; background: #f1f5f9;">
        <!-- Setup Password (First time) -->
        <div id="setupView" class="modal" style="display: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <div class="modal-header">
                <div class="modal-title">パスワードの初期設定</div>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: #64748b;">成績データを保護するため、ログインパスワードを設定してください。</p>
                <div class="control-group" style="flex-direction: column; align-items: flex-start; gap: 0.8rem;">
                    <label style="font-weight: 600;">新しいパスワード</label>
                    <input type="password" id="setupPass1"
                        style="width: 100%; border-width: 2px; font-size: 1.5rem; padding: 0.8rem; border-color: #e2e8f0; border-radius: 0.5rem;"
                        placeholder="••••••••">
                    <label style="font-weight: 600;">パスワード（確認）</label>
                    <input type="password" id="setupPass2"
                        style="width: 100%; border-width: 2px; font-size: 1.5rem; padding: 0.8rem; border-color: #e2e8f0; border-radius: 0.5rem;"
                        placeholder="••••••••">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" style="width: 100%; height: 3.5rem; font-size: 1.1rem;"
                    id="confirmSetupBtn">設定を保存して開始</button>
            </div>
        </div>

        <!-- Login View -->
        <div id="loginView" class="modal" style="display: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <div class="modal-header">
                <div class="modal-title">Grade Manager ログイン</div>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div
                        style="width: 60px; height: 60px; background: #eef2ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#4f46e5"
                            stroke-width="2" width="32" height="32">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                </div>
                <div class="control-group" style="flex-direction: column; align-items: flex-start; gap: 0.8rem;">
                    <label style="font-weight: 600;">パスワードを入力してください</label>
                    <input type="password" id="loginPass"
                        style="width: 100%; border-width: 2px; font-size: 2rem; padding: 0.8rem; text-align: center; letter-spacing: 0.5rem; border-color: #4f46e5; border-radius: 0.5rem;"
                        placeholder="••••">
                    <div id="loginError" style="color: #ef4444; font-size: 0.85rem; display: none;">パスワードが正しくありません</div>
                </div>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 1rem;">
                <button class="btn btn-primary" style="width: 100%; height: 3.5rem; font-size: 1.1rem;"
                    id="doLoginBtn">ログイン</button>
                <button id="forgotPassBtn"
                    style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 0.85rem; text-decoration: underline;">
                    パスワードを忘れた場合（システムを初期化）
                </button>
            </div>
        </div>
    </div>

    <main id="mainApp" style="display: none;">
        <aside class="sidebar">
            <div class="nav-item active" data-tab="grades" title="各科目の成績を入力・編集します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3 10h18M3 14h18m-9-4v8m-7-6h.01M3 6h18v12a2 2 0 01-2 2H5a2 2 0 01-2-2V6z" />
                </svg>
                成績一覧 (Grades)
            </div>
            <div class="nav-item" data-tab="grad_requirements" title="卒業要件の達成状況を確認します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                卒業要件 (Graduation)
            </div>
            <div class="nav-item" data-tab="stats" title="成績の統計情報とグラフを表示します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                統計・グラフ (Stats)
            </div>
            <div class="nav-item" data-tab="stats2" title="学年ごとの評点平均を表示します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                統計・グラフ2 (Stats2)
            </div>
            <div class="nav-item" data-tab="class_stats" title="クラス全体の統計情報を表示します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                クラス統計 (Class Stats)
            </div>
            <div class="nav-item" data-tab="at_risk" title="成績不振な学生を抽出します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                要注意学生 (Risk)
            </div>
            <div class="nav-item" data-tab="seating" title="座席表の作成・ランダム席決めを行います">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                </svg>
                席決め (Seats)
            </div>
            <div class="nav-item" data-tab="settings" title="学生名や科目定義を直接編集します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                各種設定 (Settings)
            </div>
            <div class="nav-item" data-tab="help" title="システムのセキュリティと使用上の注意を確認します">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                使用上のご注意 (Help)
            </div>
        </aside>

        <section class="content">
            <!-- Dedicated Print Header (Visible only during print) -->
            <div id="print-header" class="print-only">
                <div
                    style="display: flex; justify-content: space-between; border-bottom: 2pt solid #000; padding-bottom: 5px; margin-bottom: 5px;">
                    <div>
                        <h1 id="print-report-title" style="margin: 0; font-size: 18pt;">成績レポート</h1>
                        <p style="margin: 2px 0 0 0; font-size: 10pt;">成績管理システム (Grade Manager)</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="margin: 0; font-size: 12pt; font-weight: bold;">
                            学生氏名: <span id="print-student-name">-</span>
                        </p>
                        <p style="margin: 2px 0 0 0; font-size: 9pt;">発行日: <span id="print-date">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Mobile Tab Switcher (visible only on mobile) -->
            <div class="mobile-tabs" style="display: none;">
                <button class="mobile-tab active" data-tab="grades">成績一覧</button>
                <button class="mobile-tab" data-tab="stats">統計</button>
                <button class="mobile-tab" data-tab="stats2">統計2</button>
                <button class="mobile-tab" data-tab="settings">設定</button>
                <button class="mobile-tab" data-tab="help">注意</button>
            </div>

            <!-- Grades View -->
            <div id="grades-content" class="tab-content fade-in">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">通常科目 (Normal Subjects)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th width="200" title="科目の名称です">授業科目</th>
                                    <th width="60" title="この科目の単位数です">単位</th>
                                    <th width="80" title="必修・選択などの区分です">区分</th>
                                    <th width="80" title="一般・専門などの分類です">分類</th>
                                    <th width="80" title="前期中間試験の点数（クリックで貼付）">前期中間</th>
                                    <th width="80" title="前期末試験の点数（クリックで貼付）">前期末</th>
                                    <th width="80" title="後期中間試験の点数（クリックで貼付）">後期中間</th>
                                    <th width="80" title="学年末試験の点数（クリックで貼付）">学年末</th>
                                </tr>
                            </thead>
                            <tbody id="gradesBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>


                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <div class="card-title">特別学修 (Special Studies)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th width="200" title="科目の名称です">授業科目</th>
                                    <th width="60" title="単位数です">単位</th>
                                    <th width="80" title="必修・選択などの区分です">区分</th>
                                    <th width="80" title="分類です">分類</th>
                                    <th width="80" title="単位認定（修得/認定など）を入力します">認定</th>
                                </tr>
                            </thead>
                            <tbody id="specialGradesBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <div class="card-title">その他 (Others)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th width="200" title="科目の名称です">授業科目</th>
                                    <th width="60" title="単位数です">単位</th>
                                    <th width="80" title="必修・選択などの区分です">区分</th>
                                    <th width="80" title="分類です">分類</th>
                                    <th width="80" title="単位認定（修得/認定など）を入力します">認定</th>
                                </tr>
                            </thead>
                            <tbody id="otherGradesBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Graduation Requirements View -->
            <div id="grad_requirements-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header" style="justify-content: space-between; align-items: center;">
                        <div class="card-title">卒業要件 達成状況 (Graduation Requirements Progress)</div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;" class="no-print">
                            <label style="font-size: 0.85rem; font-weight: 600; color: #64748b;">所属コース:</label>
                            <select id="gradCourseFilter" class="no-print"
                                style="padding: 0.4rem 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; font-size: 0.85rem; background: #fff;">
                                <option value="">未選択 (全科目表示)</option>
                                <option value="エネルギー機械">エネルギー機械 (M)</option>
                                <option value="プロダクトデザイン">プロダクトデザイン (D)</option>
                                <option value="エレクトロニクス">エレクトロニクス (E)</option>
                                <option value="知能情報">知能情報 (I)</option>
                            </select>
                        </div>
                    </div>
                    <div id="gradRequirementsSummary"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">要件別 詳細 (Detailed Requirements)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th title="卒業判定に必要な要件の項目です">要件項目</th>
                                    <th title="必要な単位数などの目標値です">目標</th>
                                    <th title="現在の修得状況です">現在の状況</th>
                                    <th title="目標に対する達成率です">達成度</th>
                                    <th title="要件を満たしているかの判定です">判定</th>
                                </tr>
                            </thead>
                            <tbody id="gradRequirementsDetails">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <div class="card-title">必修得科目 開講スケジュール (Mandatory Subjects Schedule)</div>
                    </div>
                    <div id="mandatoryGanttChartContainer" style="overflow-x: auto; padding: 1rem;">
                        <!-- Gantt Chart will be rendered here -->
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <div class="card-title">DP別 開講スケジュール (DP Schedule)</div>
                    </div>
                    <div id="dpGanttChartContainer" style="overflow-x: auto; padding: 1rem;">
                        <!-- Gantt Chart will be rendered here -->
                    </div>
                    <div
                        style="padding: 1rem; border-top: 1px solid #f1f5f9; display: flex; gap: 1.5rem; font-size: 0.85rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; border-radius: 2px; background: #10b981;"></div>
                            <span>済 (修得済み)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; border-radius: 2px; background: #3b82f6;"></div>
                            <span>未修得 (開講予定)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats View -->
            <div id="stats-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">成績集計 (Summary)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th rowspan="2"
                                        style="min-width:40px; position:sticky; left:0; z-index:2; background:#f8fafc; border-right:1px solid #e2e8f0;">
                                        学年</th>
                                    <th colspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">前期中間</th>
                                    <th colspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">前期末</th>
                                    <th colspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">後期中間</th>
                                    <th colspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">学年末</th>
                                    <th colspan="3" style="text-align:center; border-left:1px solid #e2e8f0;">累計単位</th>
                                    <th colspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">進級判定</th>
                                    <th rowspan="2" style="text-align:center; border-left:1px solid #e2e8f0;">総合順位</th>
                                </tr>
                                <tr>
                                    <!-- Late Mid -->
                                    <th style="min-width:40px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="各試験の平均点です">平均
                                    </th>
                                    <th style="min-width:40px; text-align:center;" title="各試験の順位です">順位</th>
                                    <!-- Late Final -->
                                    <th style="min-width:40px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="各試験の平均点です">平均
                                    </th>
                                    <th style="min-width:40px; text-align:center;" title="各試験の順位です">順位</th>
                                    <!-- Early Mid -->
                                    <th style="min-width:40px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="各試験の平均点です">平均
                                    </th>
                                    <th style="min-width:40px; text-align:center;" title="各試験の順位です">順位</th>
                                    <!-- Early Final -->
                                    <th style="min-width:50px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="各試験の平均点です">平均
                                    </th>
                                    <th style="min-width:50px; text-align:center;" title="各試験の順位です">順位</th>
                                    <!-- Credits -->
                                    <th style="min-width:40px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="一般科目の修得単位数">一般
                                    </th>
                                    <th style="min-width:40px; text-align:center;" title="専門科目の修得単位数">専門</th>
                                    <th style="min-width:40px; text-align:center;" title="合計修得単位数">合計</th>
                                    <!-- Promotion -->
                                    <th style="min-width:40px; text-align:center; border-left:1px solid #e2e8f0;"
                                        title="進級に必要な単位数">必要
                                    </th>
                                    <th style="min-width:40px; text-align:center;" title="進級要件に対する不足単位数（プラスなら充足）">過不足
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="statsBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="card chart-container">
                        <div class="card-header"
                            style="margin-bottom:0.5rem; display:flex; justify-content:space-between; align-items:center;">
                            <div class="card-title">箱ひげ図 (Box Plot)</div>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <select id="boxPlotYearSelect"
                                    style="padding:0.25rem 0.5rem; border:1px solid #cbd5e1; border-radius:4px;"
                                    title="箱ひげ図に表示する学年を選択">
                                    <option value="">最新</option>
                                    <option value="1">1年</option>
                                    <option value="2">2年</option>
                                    <option value="3">3年</option>
                                    <option value="4">4年</option>
                                    <option value="5">5年</option>
                                </select>
                                <select id="boxPlotTestSelect"
                                    style="padding:0.25rem 0.5rem; border:1px solid #cbd5e1; border-radius:4px;"
                                    title="箱ひげ図に表示する試験を選択">
                                    <option value="">最新</option>
                                    <option value="前期中間">前期中間</option>
                                    <option value="前期末">前期末</option>
                                    <option value="後期中間">後期中間</option>
                                    <option value="学年末">学年末</option>
                                </select>
                            </div>
                        </div>
                        <canvas id="boxPlotChart"></canvas>
                    </div>
                    <div class="card chart-container">
                        <div class="card-header" style="margin-bottom:0.5rem">
                            <div class="card-title">成績・順位推移 (Trend)</div>
                        </div>
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stats2 View -->
            <div id="stats2-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header" style="justify-content: space-between;">
                        <div class="card-title">累積評点平均 & GPA (Cumulative Average & GPA)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th width="80">学年</th>
                                    <th width="80" style="text-align:center;">科目数</th>
                                    <th width="120" style="text-align:center;">平均点<br><span
                                            style="font-size:0.8em; font-weight:normal">(単純)</span></th>
                                    <th width="80" style="text-align:center;">順位</th>
                                    <th width="120" style="text-align:center;">平均点<br><span
                                            style="font-size:0.8em; font-weight:normal">(加重)</span></th>
                                    <th width="80" style="text-align:center;">順位</th>
                                    <th width="100" style="text-align:center;">GPA</th>
                                    <th width="80" style="text-align:center;">順位</th>
                                </tr>
                            </thead>
                            <tbody id="stats2Body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="no-print-text" style="padding: 1rem; color: #64748b; font-size: 0.85rem;">
                        ※ 各学年までの最新の評点(学年末を含む)の累積データです。<br>
                        ※ 平均点(単純): 合計点 / 科目数<br>
                        ※ 平均点(加重): Σ(点数×単位数) / Σ単位数<br>
                        ※ GPA: Σ(GP×単位数) / Σ単位数 (S:90~=4, A:80~=3, B:70~=2, C:60~=1, D/F:~59=0)
                    </div>
                    <div class="charts-grid" style="margin-top: 1.5rem;">
                        <div class="chart-container"
                            style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; height: 350px;">
                            <canvas id="stats2SimpleChart"></canvas>
                        </div>
                        <div class="chart-container"
                            style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; height: 350px;">
                            <canvas id="stats2WeightedChart"></canvas>
                        </div>
                        <div class="chart-container"
                            style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; height: 350px;">
                            <canvas id="stats2GpaChart"></canvas>
                        </div>
                    </div>

                    <!-- Old Class Statistics Section Removed -->
                </div>
            </div>

            <!-- Class Statistics View -->
            <div id="class_stats-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">クラス統計 (Class Statistics)</h2>
                    </div>
                    <div style="margin-top: 1rem;">
                        <p style="margin-bottom:1rem; color:#64748b; font-size:0.9rem;">
                            指定した学年・テスト時点でのクラス全員の成績一覧表を作成します。<br>
                            「統計・グラフ1」の平均点および「統計・グラフ2」の累積評価（単純・加重・GPA）とそれぞれの順位を表示します。
                        </p>
                        <div
                            style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; border:1px solid #e2e8f0;">
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.95rem; font-weight: 600;">対象学年:</label>
                                <select id="classStatsYear"
                                    style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.3rem; min-width:80px;">
                                    <option value="1">1年</option>
                                    <option value="2">2年</option>
                                    <option value="3">3年</option>
                                    <option value="4">4年</option>
                                    <option value="5">5年</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.95rem; font-weight: 600;">時点(テスト):</label>
                                <select id="classStatsTest"
                                    style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.3rem; min-width:100px;">
                                    <option value="前期中間">前期中間</option>
                                    <option value="前期末">前期末</option>
                                    <option value="後期中間">後期中間</option>
                                    <option value="学年末">学年末</option>
                                </select>
                            </div>
                            <button id="generateClassStatsBtn" class="btn-primary" style="padding: 0.5rem 1rem;">
                                帳票作成 (Generate Report)
                            </button>
                            <button id="exportClassStatsCsvBtn" class="btn-secondary" style="padding: 0.5rem 1rem;">
                                CSV出力 (Export CSV)
                            </button>
                            <button id="printClassStatsBtn" class="btn-secondary" style="padding: 0.5rem 1rem;">
                                PDF出力 (Print PDF)
                            </button>
                        </div>
                        <div id="classStatsContainer" style="margin-top: 2rem; overflow-x: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- At Risk Students View -->
            <div id="at_risk-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header" style="justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <h2 class="card-title">要注意学生の抽出 (Risk Student Extraction)</h2>
                        <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;"
                            class="no-print">
                            <div class="control-group">
                                <label>抽出基準:</label>
                                <select id="atRiskTypeSelect" onchange="toggleAtRiskInputs()">
                                    <option value="test">試験1回ごとの成績</option>
                                    <option value="year_avg">科目ごとの通年平均</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>学年:</label>
                                <select id="atRiskYearSelect">
                                    <option value="1">1年</option>
                                    <option value="2">2年</option>
                                    <option value="3">3年</option>
                                    <option value="4">4年</option>
                                    <option value="5">5年</option>
                                </select>
                            </div>
                            <div class="control-group" id="atRiskTestWrapper">
                                <label>対象試験:</label>
                                <select id="atRiskTestSelect">
                                    <option value="前期中間">前期中間</option>
                                    <option value="前期末" selected>前期末</option>
                                    <option value="後期中間">後期中間</option>
                                    <option value="学年末">学年末</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="renderAtRiskReport()">抽出実行</button>
                        </div>
                    </div>
                    <div id="atRiskInstructions" class="no-print"
                        style="margin-bottom: 1.5rem; padding: 1rem; background: #fff1f2; border-radius: 0.5rem; color: #991b1b; font-size: 0.85rem; border: 1px solid #fecaca;">
                        <div id="instr-test">
                            <strong>【試験1回ベース】</strong> 以下のいずれかに該当する学生を抽出：<br>
                            ・59点以下が4科目以上 / ・49点以下が3科目以上 / ・39点以下が2科目以上
                        </div>
                        <div id="instr-year_avg" class="hidden">
                            <strong>【通年平均ベース】</strong> 以下のいずれかに該当する学生を抽出：<br>
                            ・平均59点以下が3科目以上 / ・平均49点以下が2科目以上 / ・平均39点以下が1科目以上
                        </div>
                    </div>
                    <div id="atRiskReportArea">
                        <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                            条件を選択して「抽出実行」をクリックしてください。
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seating Assignment View -->
            <div id="seating-content" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="card-header"
                        style="justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <h2 class="card-title">席決め (Seating Assignment)</h2>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;" class="no-print">
                            <div class="control-group">
                                <label>列:</label>
                                <input type="number" id="seatingCols" value="7" min="1" max="20" style="width: 60px;">
                            </div>
                            <div class="control-group">
                                <label>行:</label>
                                <input type="number" id="seatingRows" value="7" min="1" max="20" style="width: 60px;">
                            </div>
                            <div class="control-group">
                                <label>視点:</label>
                                <select id="seatingPerspective" style="width: 100px;">
                                    <option value="teacher">教員</option>
                                    <option value="student">学生</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" id="updateSeatingGridBtn">グリッド更新</button>
                            <div class="divider-v"></div>
                            <div class="control-group">
                                <label>配置:</label>
                                <select id="seatingAssignMethod" style="width: 130px;">
                                    <option value="random">ランダム</option>
                                    <option value="roster_v">名簿順 (縦)</option>
                                    <option value="roster_h">名簿順 (横)</option>
                                    <option value="grades_asc">成績順 (前=低)</option>
                                </select>
                                <button class="btn btn-primary" id="autoAssignBtn">実行</button>
                            </div>
                            <button class="btn btn-secondary" id="clearSeatingBtn">クリア</button>
                            <div class="divider-v"></div>
                            <div class="control-group">
                                <label>プリセット:</label>
                                <select id="seatingPresetSelect" style="width: 150px;">
                                    <option value="">-- 選択 --</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" id="savePresetBtn">プリセット保存</button>
                            <button class="btn btn-secondary" id="deletePresetBtn">削除</button>
                            <div class="divider-v"></div>
                            <button class="btn btn-secondary" id="saveSeatingBtn">保存</button>
                            <button class="btn btn-secondary" id="loadSeatingBtn">読込</button>
                            <button class="btn btn-secondary" id="printSeatingBtn">印刷 (PDF)</button>
                            <div class="divider-v"></div>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="seatingColorByGrade"
                                        style="width: auto; margin-right: 0.25rem;">
                                    成績で色分け
                                </label>
                            </div>
                            <div class="control-group">
                                <label>計算方法:</label>
                                <select id="seatingGradeMethod" style="width: 140px;">
                                    <option value="cumulative">単純平均（累積）</option>
                                    <option value="latest">最新テストの平均</option>
                                </select>
                            </div>
                            <div id="seatingGradeMethodInfo"
                                style="font-size: 0.75rem; color: #64748b; margin-left: 0.5rem;"></div>
                        </div>
                    </div>

                    <div class="seating-wrapper"
                        style="display: grid; grid-template-columns: 280px 1fr; gap: 1.5rem; margin-top: 1rem;">
                        <!-- Roster Sidebar -->
                        <div class="seating-roster-sidebar"
                            style="background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0; padding: 1rem; height: 600px; display: flex; flex-direction: column;">
                            <h3 style="font-size: 0.95rem; font-weight: 600; margin-bottom: 0.75rem; color: #475569;">名簿
                                (学生リスト)</h3>
                            <div id="seatingRosterList"
                                style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.25rem;">
                                <!-- Populated by JS -->
                            </div>
                            <div style="margin-top: 1rem; font-size: 0.8rem; color: #64748b;">
                                ※ 学生をドラッグして席に配置できます。<br>
                                ※ 右クリックで固定・解除が可能です。
                            </div>
                        </div>

                        <!-- Seating Grid -->
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div id="seatingDesk"
                                style="text-align: center; background: #e2e8f0; padding: 0.5rem; border-radius: 0.3rem; font-weight: bold; color: #475569;">
                                教 卓 (前方)
                            </div>
                            <div id="seatingGridContainer" class="seating-grid-container"
                                style="background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; overflow: auto; min-height: 500px;">
                                <!-- Grid Canvas or Div-based Grid -->
                                <div id="seatingGrid" style="display: grid; gap: 10px; justify-content: center;">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-content" class="tab-content hidden fade-in">
                <!-- Data Management Header -->
                <div class="card" style="margin-bottom: 2rem; background: var(--primary); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="font-size: 1.5rem; margin-bottom: 0.25rem;">マスタデータ管理</h2>
                            <p style="opacity: 0.9; font-size: 0.9rem;">学生名や科目定義の全般的な管理を行います。</p>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button id="changePassBtn" class="btn"
                                style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white;">
                                パスワード変更
                            </button>
                            <button id="clearAllDataBtn" class="btn"
                                style="background: #ef4444; color: white; border: 1px solid #b91c1c;">
                                全データリセット
                            </button>
                            <button id="restoreDefaultsBtn" class="btn"
                                style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white;">
                                科目の初期化
                            </button>
                        </div>
                    </div>
                    <div
                        style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; font-size: 0.9rem;">
                        <ul style="list-style-type: disc; margin-left: 1.5rem; line-height: 1.6;">
                            <li><strong>全データリセット (Clear):</strong> 成績データ、学生リスト、変更した科目定義など、<span
                                    style="color: #fecaca; font-weight: bold;">全てのデータを消去</span>して工場出荷時に戻します。</li>
                            <li><strong>科目の初期化 (Reset Subjects):</strong> 成績データや学生リストは<span
                                    style="color: #bfdbfe; font-weight: bold;">保持したまま</span>、科目定義（単位数や必修区分など）のみを初期値に戻します。科目を間違って削除してしまった場合などに使用します。
                            </li>
                            <li><strong>パスワード変更:</strong> ログイン用のパスワードを変更します。</li>
                        </ul>
                    </div>
                    <div style="margin-top: 1rem; text-align: right;">
                        <button id="finalSaveSettingsBtn" class="btn"
                            style="background: white; color: var(--primary); font-weight: bold; border: none;">
                            すべての変更を確定保存 (Global Save)
                        </button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 320px 1fr; gap: 2rem;">
                    <!-- Left: Student List -->
                    <div class="card" style="height: fit-content;">
                        <div class="card-header"
                            style="flex-direction: column; align-items: flex-start; gap: 0.8rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem;">
                            <div class="card-title">学生リスト</div>
                            <div style="display: flex; width: 100%; gap: 0.5rem; align-items: center;">
                                <input type="number" id="newStudentId" placeholder="No."
                                    style="width: 60px; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; font-size: 0.85rem;"
                                    min="1">
                                <input type="text" id="newStudentName" placeholder="学生名"
                                    style="flex: 1; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; font-size: 0.85rem;">
                                <button id="addStudentBtn" class="btn btn-primary"
                                    style="padding: 0.5rem 0.8rem; font-size: 0.85rem;">追加</button>
                            </div>
                        </div>
                        <div id="studentsList"
                            style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem; max-height: 560px; overflow-y: auto; padding-right: 0.5rem;">
                            <!-- Student list items -->
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            <button id="exportStudentsCsvBtn" class="btn btn-secondary"
                                style="width: 100%; justify-content: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                学生リストをCSV出力
                            </button>
                        </div>
                    </div>

                    <!-- Right: Subject List -->
                    <div class="card">
                        <div class="card-header"
                            style="justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem; margin-bottom: 1.5rem;">
                            <div class="card-title">科目定義（学年別リスト）</div>
                            <div style="display: flex; gap: 0.8rem; align-items: center;">
                                <button id="exportSubjectsCsvBtn" class="btn btn-secondary" style="font-size: 0.85rem;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    CSV保存
                                </button>
                                <!-- Course Filter -->
                                <select id="subjectCourseFilter"
                                    style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; font-size: 0.85rem; margin-right: 0.5rem;">
                                    <option value="">未選択</option>
                                    <option value="エネルギー機械">エネルギー機械 (M)</option>
                                    <option value="プロダクトデザイン">プロダクトデザイン (D)</option>
                                    <option value="エレクトロニクス">エレクトロニクス (E)</option>
                                    <option value="知能情報">知能情報 (I)</option>
                                </select>
                                <div style="position: relative;">
                                    <input type="text" id="subjectSearchInput" placeholder="科目を検索..."
                                        style="padding: 0.5rem 1rem 0.5rem 2.2rem; border: 1px solid #cbd5e1; border-radius: 9999px; font-size: 0.85rem; width: 220px;">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        style="position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); color: #94a3b8;"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                                        width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <button id="addSubjectBtn" class="btn btn-primary">新規科目追加</button>
                            </div>
                        </div>

                        <div id="subjectsGroupedList" style="display: flex; flex-direction: column; gap: 2.5rem;">
                            <!-- Grouped by Year list will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help & Security View -->
            <div id="help-content" class="tab-content hidden fade-in">
                <div class="card" style="background: #f8fafc; border-left: 5px solid var(--primary);">
                    <div class="card-header">
                        <h2 class="card-title">基本的な使用方法 (Basic Usage)</h2>
                    </div>
                    <div style="line-height: 1.8; color: #334155;">
                        <ol style="margin-left: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
                            <li><strong>1. 初期設定とマスタ管理:</strong><br>
                                「各種設定 (Settings)」タブで、学生名簿と各学年の科目定義（単位数・種別・DP等）を登録します。CSVの流し込みや個別の編集が可能です。変更後は「Global
                                Save」で確定させてください。
                            </li>
                            <li><strong>2. 成績データの入力:</strong><br>
                                「成績一覧 (Grades)」タブで、対象学年と学生を選択します。各テスト点数を直接入力するか、表上部の<span class="paste-icon"
                                    style="opacity:1; vertical-align:middle; margin:0 2px;"><svg
                                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path
                                            d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                        </path>
                                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                    </svg></span>アイコンからExcel等のデータを一括貼り付けできます。
                            </li>
                            <li><strong>3. 個別・累計分析:</strong><br>
                                「分析1 (Stats)」で単一テストの分布図と順位推移、「分析2 (Stats2)」で複数年にわたるGPAと加重平均の累積推移を確認できます。
                            </li>
                            <li><strong>4. 卒業要件の確認:</strong><br>
                                「卒業要件 (Grad
                                Requirements)」では、現在の取得単位がDP（A~E）やSDGs、一般/専門科目、必修科目の基準をどの程度満たしているか自動集計します（コース選択が必要です）。
                            </li>
                            <li><strong>5. クラス帳票と要注意抽出:</strong><br>
                                「クラス統計 (Class Stats)」で全員の順位表を作成できます。また「要注意抽出 (At-Risk)」機能により、成績不振科目が複数ある学生を瞬時に特定します。
                            </li>
                        </ol>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">セキュリティとプライバシー (Security & Privacy)</h2>
                    </div>
                    <div style="line-height: 1.8; color: #334155;">
                        <p>本システムはオフライン第一の設計となっており、学生の機密情報を保持したまま安全に利用可能です。</p>
                        <ul
                            style="margin-left: 1.5rem; margin-top: 1rem; margin-bottom: 1.5rem; list-style-type: disc;">
                            <li><strong>サーバー送信なし:</strong>
                                データがインターネット上のサーバーに送信されることは<strong>一切ありません</strong>。すべての集計はブラウザ内で完結します。</li>
                            <li><strong>ローカル保存:</strong> データはブラウザの <strong>LocalStorage</strong>
                                に暗号化またはシリアル化されて保存されます。他のPCやブラウザとは同期されません。</li>
                            <li><strong>パスワード保護:</strong> 起動時にSHA-256ハッシュによるパスワード認証が必要です。設定で変更や保護の解除も可能です。</li>
                            <li style="color: #b91c1c; font-weight: bold;">使用上の注意:
                                共用PCでは必ず「Logout」して終了してください（パスワード入力画面に戻ります）。</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">入出力ファイルと用途</h2>
                    </div>
                    <div class="table-container">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f1f5f9;">
                                    <th style="padding: 10px; border: 1px solid #cbd5e1;">形式</th>
                                    <th style="padding: 10px; border: 1px solid #cbd5e1;">用途</th>
                                    <th style="padding: 10px; border: 1px solid #cbd5e1;">内容</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">PDF</td>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">配布・印刷用</td>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">個人成績レポート、推移グラフ、クラス順位表、要抽出結果など
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">JSON</td>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">バックアップ</td>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">学生・科目定義・全スコアを含む完全なデータのアーカイブ
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">CSV</td>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">データ移行・加工</td>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                        学生リスト、科目設定リスト、クラス統計一覧表（Excel等で閲覧可能）</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="border-left: 5px solid #f59e0b;">
                    <div class="card-header">
                        <h2 class="card-title" style="color: #92400e;">重要・免責事項</h2>
                    </div>
                    <div style="line-height: 1.8; color: #334155;">
                        <p style="font-weight: bold;">本システムで算出されるデータは、学習指導の参考とするための「参考値」です。</p>
                        <p style="margin-top: 1rem;">
                            平均点、順位、GPA、累計単位数等の計算結果には、システム上の端数処理や各種推定値が含まれる場合があります。単位修得の可否や進級判定等の最終的かつ公式な判断は、必ず<strong>教務発行の正式な書類（通知表、成績証明書等）</strong>を正として判断してください。
                        </p>
                        <p style="margin-top: 0.5rem; color: #b91c1c; font-size: 0.9rem;">
                            ※ 特別学修単位の算入には上限がありますが、本システムでは上限は考慮されませんのでご注意ください。
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Subject Edit Modal -->
    <div id="subjectModal" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title" id="subjectModalTitle">科目の編集</div>
                <button class="close-btn" onclick="closeSubjectModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="subjectForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <input type="hidden" id="editSubjectOldName">

                    <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                        <label>授業科目名 (Subject Name)</label>
                        <input type="text" id="subjectNameInput" style="width: 100%; border-width: 2px;"
                            placeholder="例: 数学Ⅰ" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                            <label>単位数 (Credits)</label>
                            <input type="number" id="subjectCreditsInput" style="width: 100%;" min="0" required>
                        </div>
                        <div id="subjectYearWrapper" class="control-group"
                            style="flex-direction: column; align-items: flex-start;">
                            <label>学年 (Target Year)</label>
                            <input type="number" id="subjectYearInput" style="width: 100%;" min="1" max="5" required>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div id="subjectType1Wrapper" class="control-group"
                            style="flex-direction: column; align-items: flex-start;">
                            <label>種別1 (区分)</label>
                            <select id="subjectType1Input" style="width: 100%;">
                                <option value="必履修">必履修 (要履修)</option>
                                <option value="必修得">必修得 (要単位)</option>
                                <option value="選">選 (選択)</option>
                                <option value="選必">選必 (選択必修)</option>
                                <option value="特別学修">特別学修</option>
                            </select>
                        </div>
                        <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                            <label>種別2 (一般/専門)</label>
                            <select id="subjectType2Input" style="width: 100%;">
                                <option value="一般">一般</option>
                                <option value="専門共通">専門共通</option>
                                <option value="基盤専門">基盤専門</option>
                                <option value="応用専門">応用専門</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                        <label>種別3 (詳細・管理タグ)</label>
                        <input type="text" id="subjectType3Input" list="type3Suggestions" style="width: 100%;"
                            placeholder="例: DP-A, SDGs, etc.">
                        <datalist id="type3Suggestions">
                            <option value="DP-A">
                            <option value="DP-B">
                            <option value="DP-C">
                            <option value="DP-D">
                            <option value="DP-E">
                            <option value="SDGs">
                            <option value="Other">
                        </datalist>
                    </div>
                    <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                        <label>種別4 (コース)</label>
                        <input type="text" id="subjectType4Input" list="type4Suggestions" style="width: 100%;"
                            placeholder="例: コース共通, Mコース, etc.">
                        <datalist id="type4Suggestions">
                            <option value="コース共通">
                            <option value="エネルギー機械">
                            <option value="プロダクトデザイン">
                            <option value="エレクトロニクス">
                            <option value="知能情報">
                        </datalist>
                    </div>
                    <!-- Stats Exclude Toggle -->
                    <div class="control-group"
                        style="margin-top: 1.5rem; flex-direction: row; align-items: center; gap: 0.8rem; background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        <input type="checkbox" id="excludeFromGpa"
                            style="width: 1.2rem; height: 1.2rem; cursor: pointer;">
                        <label for="excludeFromGpa"
                            style="cursor: pointer; font-weight: 500; color: #475569; margin: 0;">評定平均に考慮しない (Exclude
                            from GPA)</label>
                    </div>
                    <!-- Special Study Toggle -->
                    <div class="control-group"
                        style="margin-top: 0.5rem; flex-direction: row; align-items: center; gap: 1rem; background: #fffbeb; padding: 1.25rem; border-radius: 0.75rem; border: 2px solid #fde68a;">
                        <input type="checkbox" id="isSpecialSubject"
                            style="width: 1.5rem; height: 1.5rem; cursor: pointer;">
                        <label for="isSpecialSubject"
                            style="cursor: pointer; font-weight: 600; color: #92400e; margin: 0; font-size: 1.1rem;">特別学修科目として登録<br><span
                                style="font-size: 0.85rem; font-weight: 400; color: #b45309;">(名前の先頭に「特・」を付与します)</span></label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSubjectModal()">キャンセル</button>
                <button class="btn btn-primary" id="saveSubjectItemBtn">適用</button>
            </div>
        </div>
    </div>



    <!-- Paste Modal -->
    <div id="pasteModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">成績貼り付け (Paste Scores)</div>
                <button class="close-btn" id="closeModalBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9em;">
                    Excel、教務システム、その他の表計算ソフトからコピーした成績データを貼り付けてください。<br>
                    学年、授業科目名を含む行もそのまま貼り付けて構いません。
                </p>
                <textarea id="pasteArea" class="paste-area" placeholder="授業科目\t単位\t点数..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelPasteBtn">Cancel</button>
                <button class="btn btn-primary" id="applyPasteBtn">反映 (Apply)</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="class_stats.js"></script>
</body>

</html>